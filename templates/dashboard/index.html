{% extends 'base.html' %}

{% block title %}Dashboard Overview - Columbus AI{% endblock %}

{% block extra_head %}
<style>
    .card {
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }
    
    .stat-card {
        background: white;
        overflow: hidden;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        border-radius: 0.75rem;
        padding: 1.25rem;
    }
    
    .badge-accent {
        background: linear-gradient(135deg, var(--brand-accent) 0%, #e11d48 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .btn-brand {
        padding: 0.5rem 1.25rem;
        background: linear-gradient(135deg, var(--brand-dark) 0%, #1e40af 100%);
        color: white;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
        text-decoration: none;
        display: inline-block;
        transition: all 0.2s;
    }
    
    .btn-brand:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(15, 57, 129, 0.3);
    }
    
    .btn-outline-brand {
        padding: 0.75rem 1.5rem;
        border: 2px solid var(--brand-dark);
        color: var(--brand-dark);
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
        text-decoration: none;
        transition: all 0.2s;
    }
    
    .btn-outline-brand:hover {
        background: var(--brand-dark);
        color: white;
    }
    
    .skeleton-loading {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto" x-data="dashboardData()" x-init="loadData()">
    <!-- Page Header -->
    <div class="card mb-6">
        <div class="px-6 py-4">
            <h1 class="text-2xl font-bold" style="color: var(--brand-dark);">
                Columbus AI Dashboard 
                <span class="badge-accent ml-2">Beta</span>
            </h1>
            <p class="mt-1 text-sm text-gray-600">
                AI-Powered Job Market Intelligence 
                <span style="color: var(--brand-accent);">| By Agiliz NV</span>
            </p>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
        <!-- Total Jobs -->
        <div class="stat-card" :class="{'skeleton-loading': loading}">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="h-8 w-8" style="color: var(--brand-dark);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2m8 0V6a2 2 0 012 2v6a2 2 0 01-2 2H8a2 2 0 01-2-2V8a2 2 0 012-2V6"></path>
                    </svg>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dt class="text-sm font-medium text-gray-500 truncate">Total Jobs</dt>
                    <dd class="text-lg font-medium text-gray-900" x-text="loading ? 'Loading...' : formatNumber(stats.total_jobs)"></dd>
                </div>
            </div>
        </div>

        <!-- Total Companies -->
        <div class="stat-card" :class="{'skeleton-loading': loading}">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="h-8 w-8" style="color: var(--brand-dark);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dt class="text-sm font-medium text-gray-500 truncate">Companies</dt>
                    <dd class="text-lg font-medium text-gray-900" x-text="loading ? 'Loading...' : formatNumber(stats.total_companies)"></dd>
                </div>
            </div>
        </div>

        <!-- Data Sources -->
        <div class="stat-card" :class="{'skeleton-loading': loading}">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="h-8 w-8" style="color: var(--brand-dark);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dt class="text-sm font-medium text-gray-500 truncate">Data Sources</dt>
                    <dd class="text-lg font-medium text-gray-900" x-text="loading ? 'Loading...' : stats.total_sources"></dd>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Overview -->
    <div class="card mb-6">
        <div class="px-6 py-4">
            <h2 class="text-lg font-medium mb-4" style="color: var(--brand-dark);">Activity Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <dt class="text-sm font-medium text-gray-500">Last Scraped</dt>
                    <dd class="mt-1 text-sm text-gray-900" x-text="loading ? 'Loading...' : (stats.last_scraped || 'No data available')"></dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">First Scraped</dt>
                    <dd class="mt-1 text-sm text-gray-900" x-text="loading ? 'Loading...' : (stats.first_scraped || 'No data available')"></dd>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Jobs -->
    <div class="card mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-medium" style="color: var(--brand-dark);">Latest Jobs</h2>
                    <p class="text-xs text-gray-500 mt-0.5">Showing jobs posted in the last 2 days, scraped in the last 24 hours</p>
                </div>
                <a href="{% url 'jobs:index' %}" class="btn-brand">
                    View All Recent Jobs
                </a>
            </div>
        </div>
        <div class="divide-y divide-gray-200">
            <template x-if="loading">
                <div class="px-6 py-4 text-center text-gray-500">
                    Loading recent jobs...
                </div>
            </template>
            <template x-if="!loading && recentJobs.length === 0">
                <div class="px-6 py-4 text-center text-gray-500">
                    No recent jobs found
                </div>
            </template>
            <template x-for="job in recentJobs" :key="job.job_id">
                <div class="px-6 py-4 hover:bg-gray-50 transition">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <h3 class="text-sm font-medium text-gray-900 truncate" x-text="job.title"></h3>
                            <p class="text-sm text-gray-600">
                                <span x-text="job.company"></span>
                                <span class="mx-2">â€¢</span>
                                <span x-text="job.location"></span>
                            </p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-gray-500" x-text="job.posted_date"></span>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Columbus Chat - AI-Powered Prospect Intelligence -->
    <div class="card mb-6 p-0 overflow-hidden" x-data="columbusChat()" x-init="init()">
        <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-purple-50">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-brand-dark flex items-center gap-2">
                            Columbus Chat
                            <span class="px-2 py-0.5 text-xs font-medium bg-gradient-to-r from-blue-100 to-purple-100 text-blue-700 rounded-full">
                                Gemini 2.5 Pro
                            </span>
                        </h2>
                        <p class="text-sm text-gray-600">AI-Powered Prospect Intelligence Assistant</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button @click="resetChat()" class="px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition duration-200">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Reset
                    </button>
                    <a href="{% url 'columbus_chat:index' %}" class="px-3 py-1.5 text-sm bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 transition duration-200 shadow-md hover:shadow-lg font-medium flex items-center gap-1">
                        <span>Full Page</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                    </a>
                </div>
            </div>
        </div>
        
        <div class="flex flex-col" style="height: 600px;">
            <!-- Quick Suggestions (shown when no messages) -->
            <div x-show="messages.length === 0" class="p-4 bg-white border-b">
                <p class="text-sm font-semibold text-gray-700 mb-3">Quick Suggestions:</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <template x-for="suggestion in suggestions" :key="suggestion">
                        <button 
                            @click="sendMessage(suggestion)"
                            class="text-left p-3 text-sm bg-gradient-to-r from-purple-50 to-blue-50 hover:from-purple-100 hover:to-blue-100 rounded-lg border border-purple-200 transition">
                            <span class="text-gray-700" x-text="suggestion"></span>
                        </button>
                    </template>
                </div>
            </div>

            <!-- Messages Container -->
            <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50" x-ref="messagesContainer" style="scrollbar-width: thin;">
                <!-- Welcome Message -->
                <div x-show="messages.length === 0" class="text-center py-8">
                    <div class="inline-block p-4 bg-gradient-to-r from-purple-100 to-blue-100 rounded-full mb-3">
                        <svg class="w-12 h-12 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Welcome to Columbus Chat!</h3>
                    <p class="text-gray-600 max-w-xl mx-auto text-sm">
                        I'm your AI assistant for discovering the best prospects and partners. 
                        Ask me about companies, technologies, or let me find the perfect matches for your needs.
                    </p>
                </div>

                <!-- Chat Messages -->
                <template x-for="(message, index) in messages" :key="index">
                    <div :class="message.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                        <div :class="message.role === 'user' ? 'bg-blue-600 text-white' : 'bg-white border border-gray-200'" 
                             class="max-w-4xl rounded-lg shadow-sm p-3">
                            <!-- Message Header -->
                            <div class="flex items-center mb-2">
                                <div :class="message.role === 'user' ? 'bg-blue-700' : 'bg-purple-600'" 
                                     class="w-7 h-7 rounded-full flex items-center justify-center mr-2">
                                    <svg :class="message.role === 'user' ? '' : 'rotate-45'" class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                                <span class="font-semibold text-sm" :class="message.role === 'user' ? 'text-white' : 'text-gray-800'" 
                                      x-text="message.role === 'user' ? 'You' : 'Columbus AI'"></span>
                                <span class="text-xs ml-auto" :class="message.role === 'user' ? 'text-blue-200' : 'text-gray-500'" 
                                      x-text="formatTime(message.timestamp)"></span>
                            </div>
                            
                            <!-- Message Content -->
                            <div :class="message.role === 'user' ? 'text-white' : 'text-gray-700'" class="text-sm">
                                <div x-html="formatMessage(message.content, message.role)"></div>
                            </div>

                            <!-- Company Results -->
                            <div x-show="message.companies && message.companies.length > 0" class="mt-3 space-y-2">
                                <template x-for="company in message.companies" :key="company.company || company.company_name">
                                    <div class="bg-gradient-to-r from-gray-50 to-white border border-gray-200 rounded-lg p-3 hover:shadow-md transition">
                                        <!-- Company Header -->
                                        <div class="flex items-start justify-between mb-2">
                                            <div class="flex-1">
                                                <h4 class="font-bold text-gray-900" x-text="company.company || company.company_name"></h4>
                                                <p class="text-xs text-gray-600 mt-1">
                                                    <span x-text="company.company_type || 'Unknown Type'"></span>
                                                    <span x-show="company.company_industry" class="mx-1">â€¢</span>
                                                    <span x-text="company.company_industry"></span>
                                                </p>
                                            </div>
                                            <!-- Prospect Score -->
                                            <div x-show="company.prospect_score !== undefined" class="flex flex-col items-end ml-2">
                                                <div class="flex items-center space-x-1">
                                                    <span class="text-xl" x-text="getScoreEmoji(company.prospect_score)"></span>
                                                    <span class="text-xl font-bold" 
                                                          :class="getScoreColor(company.prospect_score)"
                                                          x-text="company.prospect_score"></span>
                                                </div>
                                                <span class="text-xs font-medium px-1.5 py-0.5 rounded mt-1" 
                                                      :class="getScoreBadgeClass(company.prospect_score)"
                                                      x-text="getScoreCategory(company.prospect_score)"></span>
                                            </div>
                                        </div>

                                        <!-- Score Breakdown Button -->
                                        <div x-show="company.prospect_score !== undefined && company.score_breakdown" class="mb-2">
                                            <button @click="company.showBreakdown = !company.showBreakdown" 
                                                    class="text-xs text-purple-600 hover:text-purple-800 font-medium flex items-center gap-1">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                <span x-text="company.showBreakdown ? 'Hide Score Details' : 'Show Score Details'"></span>
                                            </button>
                                        </div>

                                        <!-- Score Breakdown Details -->
                                        <div x-show="company.showBreakdown && company.score_breakdown" 
                                             x-collapse
                                             class="mb-2 p-2 bg-purple-50 border border-purple-200 rounded text-xs">
                                            <p class="font-semibold text-purple-900 mb-1">Score Breakdown:</p>
                                            <div class="space-y-1 text-gray-700" x-html="formatScoreBreakdown(company.score_breakdown)"></div>
                                        </div>

                                        <!-- Company Details -->
                                        <div class="grid grid-cols-2 gap-2 mb-2 text-xs text-gray-600">
                                            <div class="flex items-center">
                                                <svg class="w-3 h-3 mr-1 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                                <span x-text="company.job_count + ' jobs'"></span>
                                            </div>
                                            <div x-show="company.company_size" class="flex items-center">
                                                <svg class="w-3 h-3 mr-1 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                                <span x-text="formatCompanySize(company.company_size)"></span>
                                            </div>
                                        </div>

                                        <!-- Tech Stack -->
                                        <div x-show="(company.tech_stack || company.tech_stacks) && (company.tech_stack?.length > 0 || company.tech_stacks?.length > 0)" class="mb-2">
                                            <p class="text-xs font-semibold text-gray-700 mb-1">Tech Stack:</p>
                                            <div class="flex flex-wrap gap-1">
                                                <template x-for="tech in (company.tech_stack || company.tech_stacks || []).slice(0, 6)" :key="tech">
                                                    <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs" x-text="tech"></span>
                                                </template>
                                                <span x-show="(company.tech_stack || company.tech_stacks || []).length > 6" 
                                                      class="px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-xs"
                                                      x-text="'+' + ((company.tech_stack || company.tech_stacks || []).length - 6) + ' more'"></span>
                                            </div>
                                        </div>

                                        <!-- Actions -->
                                        <div class="flex gap-2 pt-2 border-t border-gray-200">
                                            <a :href="'/dashboard/companies/?keyword=' + encodeURIComponent(company.company || company.company_name)" 
                                               class="flex-1 text-center px-2 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded text-xs font-medium transition">
                                                View Details
                                            </a>
                                            <a :href="'/dashboard/jobs/?keyword=' + encodeURIComponent(company.company || company.company_name)" 
                                               class="flex-1 text-center px-2 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-medium transition">
                                                View Jobs
                                            </a>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Typing Indicator -->
                <div x-show="isTyping" class="flex justify-start">
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-3">
                        <div class="flex items-center">
                            <div class="bg-purple-600 w-7 h-7 rounded-full flex items-center justify-center mr-2">
                                <svg class="w-4 h-4 text-white rotate-45" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div class="flex space-x-1">
                                <span class="w-2 h-2 bg-purple-600 rounded-full animate-bounce" style="animation-delay: 0s;"></span>
                                <span class="w-2 h-2 bg-purple-600 rounded-full animate-bounce" style="animation-delay: 0.2s;"></span>
                                <span class="w-2 h-2 bg-purple-600 rounded-full animate-bounce" style="animation-delay: 0.4s;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="border-t bg-white p-3">
                <form @submit.prevent="sendMessage(userInput)" class="flex space-x-2">
                    <input 
                        type="text" 
                        x-model="userInput"
                        :disabled="isTyping"
                        placeholder="Ask me about prospects, companies, or technologies..."
                        class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed"
                    />
                    <button 
                        type="submit"
                        :disabled="!userInput.trim() || isTyping"
                        class="px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg font-medium hover:from-blue-700 hover:to-purple-700 transition disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                        Send
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card mb-6">
        <div class="px-6 py-4">
            <h2 class="text-lg font-medium mb-4" style="color: var(--brand-dark);">Quick Actions</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <a href="{% url 'jobs:index' %}" class="btn-brand text-center block flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    Browse All Jobs
                </a>
                <a href="{% url 'companies:index' %}" class="btn-outline-brand text-center block">
                    Companies
                </a>
                <a href="{% url 'configuration:index' %}" class="btn-outline-brand text-center block">
                    Configuration
                </a>
                <a href="{% url 'dashboard:api' %}" class="btn-outline-brand text-center block">
                    API Management
                </a>
            </div>
        </div>
    </div>

    <!-- Looker Dashboard & AI Chat Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Looker Dashboard Embed (2/3 width) -->
        <div class="lg:col-span-3 card p-0 overflow-hidden">
            <div class="px-4 py-2 border-b border-gray-200 bg-gray-50 flex items-center justify-between">
                <h2 class="text-sm font-semibold text-brand-dark">Analytics Dashboard</h2>
                <button onclick="document.getElementById('looker-dashboard-home').contentWindow.location.reload()" class="text-brand-dark hover:text-brand-accent transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
            </div>
            <div class="relative" style="height: 800px;">
                <iframe
                    id="looker-dashboard-home"
                    src="https://datasight.cloud.looker.com/embed/dashboards/69?embed_domain={{ request.get_host }}"
                    frameborder="0"
                    width="100%"
                    height="100%"
                    allowtransparency
                    allow="clipboard-read; clipboard-write"
                    sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox allow-downloads"
                    style="border: none; display: block;"
                ></iframe>
            </div>
        </div>

        <!-- AI Chat Interface (1/3 width) - Hidden -->
        <div class="lg:col-span-1 hidden">
            <div class="card p-0 overflow-hidden flex flex-col" style="height: 843px;">
                <div class="px-4 py-2 border-b border-gray-200 bg-gray-50">
                    <h2 class="text-sm font-semibold text-brand-dark">AI Assistant</h2>
                </div>
                
                <!-- Chat Messages Container -->
                <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50">
                    <!-- Welcome Message -->
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-600 flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-purple-500">
                                <div class="flex items-center mb-2">
                                    <h4 class="text-sm font-semibold text-gray-900">AI Analytics Assistant</h4>
                                    <span class="ml-2 px-2 py-0.5 text-xs font-medium bg-gradient-to-r from-purple-100 to-blue-100 text-purple-700 rounded-full">
                                        Gemini 2.5 Pro
                                    </span>
                                </div>
                                <p class="text-sm text-gray-700">Hello! I'm your AI-powered analytics assistant. I can help you:</p>
                                <ul class="mt-2 text-sm text-gray-600 space-y-1">
                                    <li>â€¢ Analyze job market trends and insights</li>
                                    <li>â€¢ Identify top companies and technologies</li>
                                    <li>â€¢ Explain dashboard metrics and data</li>
                                    <li>â€¢ Guide you to find contact details for companies</li>
                                </ul>
                                <p class="text-xs text-gray-500 mt-3 italic">Ask me anything about the job market data!</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Input -->
                <div class="px-6 py-4 border-t border-gray-200 bg-white">
                    <form id="chatForm" class="flex space-x-2">
                        <input 
                            type="text" 
                            id="chatInput" 
                            placeholder="Ask me about job trends, companies, or technologies..." 
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                        >
                        <button 
                            type="submit" 
                            class="px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 transition duration-200 shadow-md hover:shadow-lg"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </form>
                    <p class="text-xs text-gray-500 mt-2 text-center">Powered by Google Gemini 2.5 Pro â€¢ Your data stays private</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Run Configuration Snapshot -->
    <div class="card">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium" style="color: var(--brand-dark);">Run Configuration</h2>
        </div>
        <div class="px-6 py-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div>
                <div class="text-gray-500">Project</div>
                <div class="font-medium" style="color: var(--brand-dark);">{{ GOOGLE_CLOUD_PROJECT_ID }}</div>
            </div>
            <div>
                <div class="text-gray-500">Region</div>
                <div class="font-medium" style="color: var(--brand-dark);">{{ GOOGLE_CLOUD_REGION }}</div>
            </div>
            <div>
                <div class="text-gray-500">BigQuery Dataset</div>
                <div class="font-medium" style="color: var(--brand-dark);">{{ BIGQUERY_DATASET }}</div>
            </div>
            <div>
                <div class="text-gray-500">Default Query Window</div>
                <div class="font-medium" style="color: var(--brand-dark);">30 days</div>
            </div>
        </div>
        <div class="px-6 pb-4">
            <a href="{% url 'configuration:index' %}" class="btn-brand">Open Full Configuration</a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function dashboardData() {
    return {
        loading: true,
        stats: {
            total_jobs: 0,
            total_companies: 0,
            total_sources: 0,
            last_scraped: '',
            first_scraped: ''
        },
        recentJobs: [],
        
        async loadData() {
            try {
                const response = await fetch('{% url "dashboard:stats" %}', {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load dashboard data');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    this.stats = data.stats;
                    this.recentJobs = data.recentJobs || [];
                } else {
                    console.error('Error:', data.error);
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            } finally {
                this.loading = false;
            }
        },
        
        formatNumber(num) {
            if (!num && num !== 0) return '0';
            return num.toLocaleString();
        }
    }
}

// AI Chat functionality with Gemini integration
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const chatMessages = document.getElementById('chatMessages');
    
    if (chatForm) {
        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const message = chatInput.value.trim();
            if (!message) return;
            
            // Disable input while processing
            chatInput.disabled = true;
            chatForm.querySelector('button').disabled = true;
            
            // Add user message
            addChatMessage(message, 'user');
            chatInput.value = '';
            
            // Show typing indicator
            const typingId = showTypingIndicator();
            
            try {
                // Get CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                // Call backend API
                const response = await fetch('{% url "dashboard:analytics_chat" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ message: message })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                removeTypingIndicator(typingId);
                
                if (data.success) {
                    addChatMessage(data.message, 'ai');
                } else {
                    addChatMessage(data.message || 'Sorry, I encountered an error. Please try again.', 'ai', true);
                }
            } catch (error) {
                // Remove typing indicator
                removeTypingIndicator(typingId);
                
                console.error('Chat error:', error);
                addChatMessage('Sorry, I\'m having trouble connecting. Please try again in a moment.', 'ai', true);
            } finally {
                // Re-enable input
                chatInput.disabled = false;
                chatForm.querySelector('button').disabled = false;
                chatInput.focus();
            }
        });
    }
});

function showTypingIndicator() {
    const chatMessages = document.getElementById('chatMessages');
    const id = 'typing-' + Date.now();
    
    const typingHtml = `
        <div id="${id}" class="flex items-start space-x-3">
            <div class="flex-shrink-0">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-600 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </div>
            </div>
            <div class="flex-1">
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <div class="flex space-x-2">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    chatMessages.insertAdjacentHTML('beforeend', typingHtml);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    return id;
}

function removeTypingIndicator(id) {
    const element = document.getElementById(id);
    if (element) {
        element.remove();
    }
}

function formatMarkdown(text) {
    // Convert markdown to HTML
    // Bold **text**
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Italic *text*
    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // Links [text](url)
    text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-blue-600 hover:text-blue-800 underline">$1</a>');
    
    // Bullet points
    text = text.replace(/^[â€¢\-\*]\s+(.+)$/gm, '<li class="ml-4">$1</li>');
    text = text.replace(/(<li[^>]*>.*<\/li>)/s, '<ul class="list-disc space-y-1 my-2">$1</ul>');
    
    // Line breaks
    text = text.replace(/\n\n/g, '</p><p class="mt-2">');
    text = '<p>' + text + '</p>';
    
    return text;
}

function addChatMessage(message, sender = 'user', isError = false) {
    const chatMessages = document.getElementById('chatMessages');
    
    // Create a temporary div to escape HTML
    const tempDiv = document.createElement('div');
    tempDiv.textContent = message;
    const escapedMessage = tempDiv.innerHTML;
    
    if (sender === 'user') {
        const messageHtml = `
            <div class="flex items-start space-x-3 justify-end">
                <div class="flex-1 text-right">
                    <div class="inline-block bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg shadow-sm p-4 max-w-md">
                        <p class="text-sm">${escapedMessage}</p>
                    </div>
                </div>
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        `;
        chatMessages.insertAdjacentHTML('beforeend', messageHtml);
    } else {
        const formattedMessage = formatMarkdown(escapedMessage);
        const borderClass = isError ? 'border-l-4 border-red-500' : 'border-l-4 border-purple-500';
        
        const messageHtml = `
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-600 flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                </div>
                <div class="flex-1">
                    <div class="bg-white rounded-lg shadow-sm p-4 ${borderClass}">
                        <div class="text-sm text-gray-700 prose prose-sm max-w-none">${formattedMessage}</div>
                    </div>
                </div>
            </div>
        `;
        chatMessages.insertAdjacentHTML('beforeend', messageHtml);
    }
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function refreshLooker() {
    const iframe = document.getElementById('looker-dashboard-home');
    if (iframe) {
        iframe.src = iframe.src;
    }
}

// Columbus Chat Alpine.js Component
function columbusChat() {
    return {
        messages: [],
        userInput: '',
        isTyping: false,
        suggestions: [],

        init() {
            this.loadSuggestions();
        },

        async loadSuggestions() {
            try {
                const response = await fetch('/dashboard/columbus/suggestions/');
                const data = await response.json();
                if (data.success) {
                    this.suggestions = data.suggestions;
                }
            } catch (error) {
                console.error('Error loading suggestions:', error);
            }
        },

        async sendMessage(message) {
            if (typeof message === 'string') {
                this.userInput = message;
            }
            
            const messageText = this.userInput.trim();
            if (!messageText) return;

            // Add user message
            this.messages.push({
                role: 'user',
                content: messageText,
                timestamp: new Date()
            });

            this.userInput = '';
            this.isTyping = true;
            this.scrollToBottom();

            try {
                const response = await fetch('/dashboard/columbus/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    },
                    body: JSON.stringify({ message: messageText })
                });

                const data = await response.json();
                
                if (data.success) {
                    // Normalize company data to ensure company_name is always available
                    const companies = data.data;
                    if (Array.isArray(companies)) {
                        companies.forEach(company => {
                            // Ensure both company and company_name fields exist
                            if (company.company && !company.company_name) {
                                company.company_name = company.company;
                            } else if (company.company_name && !company.company) {
                                company.company = company.company_name;
                            }
                            // Fallback: use company_id if neither exists
                            if (!company.company && !company.company_name && company.company_id) {
                                company.company = company.company_id;
                                company.company_name = company.company_id;
                            }
                            console.log('Company data:', {
                                company: company.company,
                                company_name: company.company_name,
                                company_id: company.company_id
                            });
                        });
                    }
                    
                    // Add AI response
                    this.messages.push({
                        role: 'assistant',
                        content: data.response,
                        companies: companies,
                        timestamp: new Date()
                    });
                } else {
                    this.messages.push({
                        role: 'assistant',
                        content: 'Sorry, I encountered an error: ' + (data.error || 'Unknown error'),
                        timestamp: new Date()
                    });
                }
            } catch (error) {
                console.error('Error sending message:', error);
                this.messages.push({
                    role: 'assistant',
                    content: 'Sorry, I encountered a connection error. Please try again.',
                    timestamp: new Date()
                });
            } finally {
                this.isTyping = false;
                this.scrollToBottom();
            }
        },

        async resetChat() {
            if (!confirm('Are you sure you want to reset the conversation?')) {
                return;
            }

            try {
                await fetch('/dashboard/columbus/reset/', { 
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    }
                });
                this.messages = [];
                this.userInput = '';
            } catch (error) {
                console.error('Error resetting chat:', error);
            }
        },

        scrollToBottom() {
            this.$nextTick(() => {
                const container = this.$refs.messagesContainer;
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            });
        },

        formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        },

        formatCompanySize(size) {
            if (!size) return 'Unknown';
            if (typeof size === 'string') return size;
            if (size >= 10000) return '10,000+ employees';
            if (size >= 1000) return '1,000-10,000 employees';
            if (size >= 500) return '500-1,000 employees';
            if (size >= 100) return '100-500 employees';
            if (size >= 50) return '50-100 employees';
            return size + ' employees';
        },

        getScoreEmoji(score) {
            if (score >= 70) return 'ðŸ”¥';
            if (score >= 50) return 'â­';
            if (score >= 30) return 'â„ï¸';
            return 'ðŸš«';
        },

        getScoreColor(score) {
            if (score >= 70) return 'text-red-600';
            if (score >= 50) return 'text-yellow-600';
            if (score >= 30) return 'text-blue-600';
            return 'text-gray-600';
        },

        getScoreBadgeClass(score) {
            if (score >= 70) return 'bg-red-100 text-red-700';
            if (score >= 50) return 'bg-yellow-100 text-yellow-700';
            if (score >= 30) return 'bg-blue-100 text-blue-700';
            return 'bg-gray-100 text-gray-700';
        },

        getScoreCategory(score) {
            if (score >= 70) return 'Hot';
            if (score >= 50) return 'Warm';
            if (score >= 30) return 'Cold';
            return 'Avoid';
        },

        formatScoreBreakdown(breakdown) {
            if (!breakdown) return '';
            
            // If breakdown is a string, return it
            if (typeof breakdown === 'string') {
                return breakdown.replace(/\n/g, '<br>');
            }
            
            // If breakdown is an object, format it
            let html = '';
            for (const [key, value] of Object.entries(breakdown)) {
                const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                html += `<div class="flex justify-between"><span>${label}:</span><span class="font-semibold">${value}</span></div>`;
            }
            return html;
        },

        formatMessage(content, role) {
            if (role === 'user') {
                return `<p class="whitespace-pre-wrap">${this.escapeHtml(content)}</p>`;
            }
            
            let formatted = this.escapeHtml(content);
            
            formatted = formatted.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-blue-600 hover:text-blue-800 underline">$1</a>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/^###\s+(.+)$/gm, '<h3 class="text-base font-bold mt-3 mb-2">$1</h3>');
            formatted = formatted.replace(/^\d+\.\s+\*\*(.*?)\*\*$/gm, (match, p1) => {
                return `<div class="font-bold text-base mt-3 mb-2">${p1}</div>`;
            });
            formatted = formatted.replace(/^\s*[*-]\s+\*\*(.*?)\*\*:\s*(.*?)$/gm, (match, label, text) => {
                return `<div class="ml-3 mb-2"><span class="font-semibold text-gray-900">${label}:</span> <span class="text-gray-700">${text}</span></div>`;
            });
            formatted = formatted.replace(/^\s*[*-]\s+(.+)$/gm, '<div class="ml-3 mb-1">â€¢ $1</div>');
            formatted = formatted.replace(/\n\n/g, '</p><p class="mt-2">');
            formatted = formatted.replace(/\n/g, '<br>');
            
            return `<div class="leading-relaxed">${formatted}</div>`;
        },

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    };
}
</script>
{% endblock %}
