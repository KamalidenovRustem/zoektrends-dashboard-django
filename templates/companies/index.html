{% extends 'base.html' %}
{% load static %}

{% block title %}Companies - Columbus AI{% endblock %}

{% block extra_head %}
<!-- Marked.js for Markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
    /* Columbus AI Logo Animation */
    @keyframes spin-slow {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }
    
    .animate-spin-slow {
        animation: spin-slow 3s linear infinite;
    }
    
    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
    
    /* Line Clamp */
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
{% endblock %}

{% block content %}
<div 
    x-data="companiesData()"
    x-init="init()"
    class="relative flex flex-col min-[1410px]:flex-row h-[calc(100vh-64px)] bg-gray-50 overflow-hidden"
>


    <!-- Filters Sidebar -->
    <div class="bg-white w-full min-[1410px]:w-80 flex-shrink-0 overflow-y-auto border-b min-[1410px]:border-b-0 min-[1410px]:border-r border-gray-200">
        <div class="p-4 min-[1410px]:p-6 space-y-4 min-[1410px]:space-y-6 max-[1409px]:flex max-[1409px]:flex-wrap max-[1409px]:gap-3">
            <!-- Header -->
            <div class="max-[1409px]:flex max-[1409px]:items-center max-[1409px]:gap-3 max-[1409px]:flex-shrink-0">
                <h2 class="text-base min-[1410px]:text-2xl font-bold text-gray-900">Companies</h2>
                <p class="text-xs min-[1410px]:text-sm text-gray-600 max-[1409px]:mt-0 min-[1410px]:mt-1">
                    <span x-text="companies.length"></span> found
                </p>
                <div class="max-[1409px]:mt-0 min-[1410px]:mt-2 flex items-center gap-2">
                    <span 
                        x-show="filters.relevant === 'relevant'" 
                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"
                    >
                        âœ“ Showing Relevant Only
                    </span>
                    <span 
                        x-show="filters.relevant === 'all'" 
                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
                    >
                        Showing All Companies
                    </span>
                    <!-- Status Legend Button -->
                    <div class="relative" x-data="{ showLegend: false }">
                        <button 
                            @click="showLegend = !showLegend"
                            class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-300 transition-colors"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
                            </svg>
                            Status Legend
                        </button>
                        <!-- Legend Popup -->
                        <div 
                            x-show="showLegend"
                            @click.away="showLegend = false"
                            x-transition:enter="transition ease-out duration-200"
                            x-transition:enter-start="opacity-0 scale-95"
                            x-transition:enter-end="opacity-100 scale-100"
                            x-transition:leave="transition ease-in duration-150"
                            x-transition:leave-start="opacity-100 scale-100"
                            x-transition:leave-end="opacity-0 scale-95"
                            class="absolute z-50 mt-2 w-72 bg-white rounded-lg shadow-xl border border-gray-200 p-4 left-0"
                            style="display: none;"
                        >
                            <h3 class="text-sm font-semibold text-gray-900 mb-3">Company Status Colors</h3>
                            <div class="space-y-2">
                                <div class="flex items-center gap-2">
                                    <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-purple-100 text-purple-800 border border-purple-300">Prospect</span>
                                    <span class="text-xs text-gray-600">Potential lead</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800 border border-blue-300">Follow up</span>
                                    <span class="text-xs text-gray-600">Under consideration</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800 border border-green-300">Qualified</span>
                                    <span class="text-xs text-gray-600">Meets criteria</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-800 border border-emerald-300">Customer</span>
                                    <span class="text-xs text-gray-600">Active customer</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800 border border-red-300">Not relevant</span>
                                    <span class="text-xs text-gray-600">Filtered out</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800 border border-yellow-300">Undecided</span>
                                    <span class="text-xs text-gray-600">Needs review</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Relevant/All Toggle -->
            <div class="bg-gray-50 rounded-lg p-2 min-[1410px]:p-4 border border-gray-200 max-[1409px]:flex-shrink-0">
                <div class="flex items-center justify-between mb-1 min-[1410px]:mb-2 max-[1409px]:hidden">
                    <label class="text-sm font-semibold text-gray-900">Filter Mode</label>
                </div>
                <div class="flex gap-1 min-[1410px]:gap-2">
                    <button
                        @click="filters.relevant = 'relevant'; applyFilters()"
                        :class="filters.relevant === 'relevant' ? 'bg-gradient-to-r from-green-600 to-green-700 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-100'"
                        class="flex-1 px-2 py-1.5 min-[1410px]:px-4 min-[1410px]:py-2.5 rounded-lg font-semibold text-xs min-[1410px]:text-sm transition-all border border-gray-300"
                    >
                        <div class="flex items-center justify-center gap-1">
                            <svg class="w-3 h-3 min-[1410px]:w-4 min-[1410px]:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span class="max-[1409px]:hidden">Relevant</span>
                            <span class="min-[1410px]:hidden">Rel</span>
                        </div>
                    </button>
                    <button
                        @click="filters.relevant = 'to_review'; applyFilters()"
                        :class="filters.relevant === 'to_review' ? 'bg-gradient-to-r from-yellow-500 to-yellow-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-100'"
                        class="flex-1 px-2 py-1.5 min-[1410px]:px-4 min-[1410px]:py-2.5 rounded-lg font-semibold text-xs min-[1410px]:text-sm transition-all border border-gray-300"
                    >
                        <span class="max-[1409px]:hidden">To Review</span>
                        <span class="min-[1410px]:hidden">Rev</span>
                    </button>
                    <button
                        @click="filters.relevant = 'all'; applyFilters()"
                        :class="filters.relevant === 'all' ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-100'"
                        class="flex-1 px-2 py-1.5 min-[1410px]:px-4 min-[1410px]:py-2.5 rounded-lg font-semibold text-xs min-[1410px]:text-sm transition-all border border-gray-300"
                    >
                        <span>All</span>
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center" x-show="filters.relevant === 'relevant'">
                    Showing: Prospect, Follow up, Qualified, Customer
                </p>
                <p class="text-xs text-gray-500 mt-2 text-center" x-show="filters.relevant === 'to_review'">
                    Showing: Undecided (excluding IT consulting companies)
                </p>
            </div>

            <!-- Company Status Filter -->
            <div class="relative max-[1409px]:flex-shrink-0" x-data="{ open: false }" @click.away="open = false">
                <label class="block text-sm font-medium text-gray-700 mb-2 max-[1409px]:hidden">
                    Status
                </label>
                <button
                    @click="open = !open"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm bg-white text-left flex items-center justify-between gap-2"
                >
                    <span x-text="selectedStatuses.length > 0 ? selectedStatuses.length + ' selected' : 'All Status'"></span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div x-show="open" x-transition class="absolute z-[9999] mt-1 w-64 bg-white border border-gray-300 rounded-lg shadow-lg max-h-64 overflow-y-auto">
                    <label class="flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" value="Undecided" x-model="selectedStatuses" @change="applyStatusFilter()" class="mr-2 rounded">
                        <span class="text-sm">Undecided</span>
                    </label>
                    <label class="flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" value="Prospect" x-model="selectedStatuses" @change="applyStatusFilter()" class="mr-2 rounded">
                        <span class="text-sm">Prospect</span>
                    </label>
                    <label class="flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" value="Follow up" x-model="selectedStatuses" @change="applyStatusFilter()" class="mr-2 rounded">
                        <span class="text-sm">Follow up</span>
                    </label>
                    <label class="flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" value="Qualified" x-model="selectedStatuses" @change="applyStatusFilter()" class="mr-2 rounded">
                        <span class="text-sm">Qualified</span>
                    </label>
                    <label class="flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" value="Qualify out competition" x-model="selectedStatuses" @change="applyStatusFilter()" class="mr-2 rounded">
                        <span class="text-sm">Qualify out competition</span>
                    </label>
                    <label class="flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" value="Qualify out wrong info" x-model="selectedStatuses" @change="applyStatusFilter()" class="mr-2 rounded">
                        <span class="text-sm">Qualify out wrong info</span>
                    </label>
                    <label class="flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" value="Rejected" x-model="selectedStatuses" @change="applyStatusFilter()" class="mr-2 rounded">
                        <span class="text-sm">Rejected</span>
                    </label>
                    <label class="flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" value="Customer" x-model="selectedStatuses" @change="applyStatusFilter()" class="mr-2 rounded">
                        <span class="text-sm">Customer</span>
                    </label>
                </div>
            </div>

            <!-- Keyword Search -->
            <div class="max-[1409px]:flex-1 max-[1409px]:min-w-[200px]">
                <label class="block text-sm font-medium text-gray-700 mb-2 max-[1409px]:hidden">
                    Search Companies
                </label>
                <div class="min-[1410px]:space-y-2">
                    <input
                        type="text"
                        x-model="filters.keyword"
                        @keydown.enter="applyFilters()"
                        placeholder="Search companies..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                    />
                    <button
                        @click="applyFilters()"
                        class="max-[1409px]:hidden w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium"
                    >
                        Search
                    </button>
                </div>
            </div>

            <!-- Country Filter -->
            <div class="max-[1409px]:flex-shrink-0">
                <label class="block text-sm font-medium text-gray-700 mb-2 max-[1409px]:hidden">
                    Country
                </label>
                <select
                    x-model="filters.country"
                    @change="applyFilters()"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                >
                    <option value="">All Countries</option>
                    {% for country in filter_options.countries %}
                    <option value="{{ country }}">{{ country }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Tech Stack Filter (Checkbox Dropdown) -->
            <div class="relative max-[1409px]:flex-shrink-0" x-data="{ open: false }" @click.away="open = false">
                <label class="block text-sm font-medium text-gray-700 mb-2 max-[1409px]:hidden">
                    Tech Stack
                </label>
                <button
                    @click="open = !open"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm bg-white text-left flex items-center justify-between gap-2"
                >
                    <span x-text="selectedTechs.length > 0 ? selectedTechs.length + ' selected' : 'All Tech'"></span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div x-show="open" x-transition class="absolute z-[9999] mt-1 w-64 bg-white border border-gray-300 rounded-lg shadow-lg max-h-64 overflow-y-auto">
                    <template x-for="tech in availableTechs" :key="tech">
                        <label class="flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer">
                            <input 
                                type="checkbox" 
                                :value="tech"
                                :checked="selectedTechs.includes(tech)"
                                @change="toggleTech(tech)"
                                class="mr-2 rounded"
                            >
                            <span class="text-sm" x-text="tech"></span>
                        </label>
                    </template>
                </div>
            </div>

            <!-- Minimum Jobs Filter -->
            <div class="max-[1409px]:flex-shrink-0">
                <label class="block text-sm font-medium text-gray-700 mb-2 max-[1409px]:hidden">
                    Min Jobs
                </label>
                <input
                    type="number"
                    x-model.number="filters.min_jobs"
                    @change="applyFilters()"
                    min="1"
                    placeholder="Min jobs"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                />
            </div>

            <!-- Sort By -->
            <div class="max-[1409px]:flex-shrink-0">
                <label class="block text-sm font-medium text-gray-700 mb-2 max-[1409px]:hidden">
                    Sort
                </label>
                <select
                    x-model="filters.sort_by"
                    @change="applyFilters()"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                >
                    <option value="company_name">Name (A-Z)</option>
                    <option value="company_asc">Name (A-Z) Legacy</option>
                    <option value="company_desc">Name (Z-A)</option>
                    <option value="job_count_desc">Most Jobs</option>
                    <option value="job_count_asc">Least Jobs</option>
                </select>
            </div>

            <!-- Limit -->
            <div class="max-[1409px]:hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Results Limit
                </label>
                <select
                    x-model.number="filters.limit"
                    @change="applyFilters()"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                >
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                    <option value="500">500</option>
                    <option value="1000">1000</option>
                </select>
            </div>

            <!-- Reset Button -->
            <button
                @click="resetFilters()"
                class="max-[1409px]:hidden w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm"
            >
                Reset Filters
            </button>
        </div>
    </div>

    <!-- Wrapper for Companies + Details (side by side below filters) -->
    <div class="flex flex-1 overflow-hidden relative max-[1409px]:overflow-y-auto">
    <!-- Middle Section - Company Cards -->
    <div class="flex-1 overflow-y-auto bg-gray-50">
        <div class="p-3 sm:p-6">
            <!-- Loading State -->
            <div x-show="loading" class="flex items-center justify-center h-64">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            </div>

            <!-- Error State -->
            <div x-show="error && !loading" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                <p class="text-red-800" x-text="error"></p>
            </div>
            
            <!-- Results Count & Load All Button -->
            <div x-show="!loading && companies.length > 0" class="mb-4 flex items-center justify-between bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                <div class="text-sm text-gray-700">
                    Showing <span class="font-semibold text-blue-600" x-text="visibleCompanies.length"></span> of 
                    <span class="font-semibold" x-text="companies.length"></span> companies
                </div>
                <button 
                    x-show="displayedCount < companies.length"
                    @click="loadAllCompanies()"
                    class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors"
                >
                    Load All (<span x-text="companies.length"></span>)
                </button>
            </div>

            <!-- Company Cards Grid -->
            <div 
                x-show="!loading && companies.length > 0"
                class="grid gap-3 sm:gap-4 grid-cols-1 min-[1050px]:grid-cols-2"
                :class="!selectedCompany && window.innerWidth >= 1520 ? 'xl:grid-cols-3' : ''"
            >
                <template x-for="company in visibleCompanies" :key="company.company">
                    <div
                        @click="selectCompany(company)"
                        :class="selectedCompany?.company === company.company ? 'ring-2 ring-blue-500' : ''"
                        class="bg-white rounded-lg shadow hover:shadow-lg transition-shadow cursor-pointer p-6 border border-gray-200"
                    >
                        <!-- Company Header -->
                        <div class="mb-4">
                            <!-- Company Name, Size & Status -->
                            <div class="flex flex-wrap items-center gap-2 mb-2">
                                <h3 class="text-xl sm:text-2xl font-bold text-gray-900 break-words" x-text="company.company"></h3>
                                <span x-show="company.company_size" class="inline-flex items-center px-2.5 py-1 rounded-lg text-sm font-semibold bg-gray-200 text-gray-700" x-text="company.company_size"></span>
                                <!-- Status Badge -->
                                <span 
                                    class="px-2.5 py-1 rounded-full text-xs font-semibold border"
                                    :class="{
                                        'bg-purple-100 text-purple-800 border-purple-300': company.status === 'Prospect',
                                        'bg-blue-100 text-blue-800 border-blue-300': company.status === 'Follow up',
                                        'bg-green-100 text-green-800 border-green-300': company.status === 'Qualified',
                                        'bg-emerald-100 text-emerald-800 border-emerald-300': company.status === 'Customer',
                                        'bg-red-100 text-red-800 border-red-300': company.status === 'Not relevant' || company.status === 'Rejected' || company.status === 'Qualify out competition' || company.status === 'Qualify out wrong info',
                                        'bg-yellow-100 text-yellow-800 border-yellow-300': !company.status || company.status === 'Undecided'
                                    }"
                                    x-text="company.status || 'Undecided'"
                                ></span>
                            </div>
                            
                            <!-- Company Type & Industry -->
                            <div class="space-y-1 mb-3">
                                <p x-show="company.company_type" class="text-base font-medium text-indigo-700" x-text="company.company_type"></p>
                                <p x-show="company.company_industry" class="text-base text-gray-600" x-text="company.company_industry"></p>
                            </div>
                            
                            <!-- Job Count Badge -->
                            <div>
                                <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-semibold bg-blue-100 text-blue-800">
                                    <svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd"/>
                                        <path d="M2 13.692V16a2 2 0 002 2h12a2 2 0 002-2v-2.308A24.974 24.974 0 0110 15c-2.796 0-5.487-.46-8-1.308z"/>
                                    </svg>
                                    <span x-text="company.job_count"></span> 
                                    <span x-text="company.job_count === 1 ? ' opening' : ' openings'"></span>
                                </span>
                            </div>
                        </div>

                        <!-- Locations -->
                        <div x-show="company.locations && company.locations.length > 0" class="mb-3">
                            <div class="flex items-center gap-1 mb-1.5">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <span class="text-sm font-medium text-gray-700">Locations:</span>
                            </div>
                            <div class="flex flex-wrap gap-1.5">
                                <template x-for="location in company.locations.slice(0, 3)" :key="location">
                                    <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-sm bg-gray-100 text-gray-700" x-text="location"></span>
                                </template>
                                <span x-show="company.locations.length > 3" class="inline-flex items-center px-2.5 py-1 rounded-lg text-sm bg-gray-100 text-gray-700">
                                    +<span x-text="company.locations.length - 3"></span> more
                                </span>
                            </div>
                        </div>

                        <!-- Countries -->
                        <div x-show="company.countries && company.countries.length > 0" class="mb-3">
                            <div class="flex items-center gap-1 mb-1.5">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span class="text-sm font-medium text-gray-700">Countries:</span>
                            </div>
                            <div class="flex flex-wrap gap-1.5">
                                <template x-for="country in company.countries" :key="country">
                                    <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-sm bg-green-100 text-green-700" x-text="country"></span>
                                </template>
                            </div>
                        </div>

                        <!-- Sources -->
                        <div x-show="company.sources && company.sources.length > 0" class="mb-3">
                            <div class="flex items-center gap-1 mb-1.5">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                                </svg>
                                <span class="text-sm font-medium text-gray-700">Sources:</span>
                            </div>
                            <div class="flex flex-wrap gap-1.5">
                                <template x-for="source in company.sources" :key="source">
                                    <span 
                                        class="inline-flex items-center px-2.5 py-1 rounded-lg text-sm font-medium"
                                        :class="{
                                            'bg-blue-100 text-blue-700': source.toLowerCase().includes('linkedin'),
                                            'bg-purple-100 text-purple-700': source.toLowerCase().includes('adzuna'),
                                            'bg-gray-100 text-gray-700': !source.toLowerCase().includes('linkedin') && !source.toLowerCase().includes('adzuna')
                                        }"
                                        x-text="source"
                                    ></span>
                                </template>
                            </div>
                        </div>

                        <!-- Tech Stacks -->
                        <div x-show="company.tech_stacks && company.tech_stacks.length > 0" class="mb-3">
                            <div class="flex items-center gap-1 mb-1.5">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                                </svg>
                                <span class="text-sm font-medium text-gray-700">Tech Stack:</span>
                                <span class="text-sm text-gray-500" x-text="`(${company.tech_stacks.length})`"></span>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="tech in company.tech_stacks.slice(0, 8)" :key="tech">
                                    <span 
                                        class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium border"
                                        :class="getTechStackColor(tech)"
                                        x-text="tech"
                                    ></span>
                                </template>
                                <span x-show="company.tech_stacks.length > 8" class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-50 text-gray-600 border border-gray-300">
                                    +<span x-text="company.tech_stacks.length - 8"></span> more
                                </span>
                            </div>
                        </div>

                        <!-- Last Job Date -->
                        <div class="text-sm text-gray-500 mt-3">
                            Last job: <span x-text="formatDate(company.last_job_date)"></span>
                        </div>
                    </div>
                </template>
            </div>

            <!-- No Results -->
            <div x-show="!loading && companies.length === 0" class="text-center py-12">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No companies found</h3>
                <p class="mt-1 text-sm text-gray-500">Try adjusting your filters</p>
            </div>
        </div>
    </div>

    <!-- Right Sidebar - Company Details & AI Chat -->
    <div 
        x-show="selectedCompany"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-x-full"
        x-transition:enter-end="opacity-100 translate-x-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 translate-x-0"
        x-transition:leave-end="opacity-0 translate-x-full"
        class="bg-white overflow-hidden flex flex-col border-l border-gray-200"
        :class="window.innerWidth < 780 ? 'absolute inset-0 z-50 w-full' : 'w-96 min-[1500px]:w-auto min-[1500px]:flex-1 min-[1500px]:max-w-[450px]'"
        style="display: none;"
    >
        <!-- Header -->
        <div class="flex items-center justify-between p-4 border-b border-gray-200 bg-white sticky top-0 z-10">
            <h3 class="text-lg font-semibold text-gray-900">Company Details</h3>
            <button
                @click="selectedCompany = null; showAiChat = false"
                class="text-gray-400 hover:text-gray-600 transition-colors"
            >
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Content Area (scrollable) -->
        <div class="flex-1 overflow-y-auto p-4 lg:p-5 space-y-4 lg:space-y-5">
            <template x-if="selectedCompany">
                <div>
                    <!-- Company Name & Stats -->
                    <div class="mb-4 pb-3 border-b border-gray-200">
                        <h2 class="text-xl font-bold text-gray-900 mb-2" x-text="selectedCompany.company"></h2>
                        <div class="flex items-center gap-3">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                </svg>
                                <span x-text="selectedCompany.job_count"></span> <span x-text="selectedCompany.job_count === 1 ? 'opening' : 'openings'"></span>
                            </span>
                        </div>
                    </div>

                    <!-- AI-Generated Description (Placeholder) -->
                    <div class="bg-gradient-to-br from-purple-50 to-blue-50 border-2 border-purple-200 rounded-lg p-4 shadow-sm mb-4">
                        <div class="flex items-start mb-3">
                            <div class="bg-gradient-to-br from-purple-500 to-blue-600 rounded-lg p-2 mr-3 flex-shrink-0">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-bold text-gray-900 mb-1">AI-Generated Description</h4>
                                <p class="text-xs text-purple-600 font-medium">Powered by Google Gemini 2.5 Pro</p>
                            </div>
                        </div>
                        <p class="text-sm text-gray-800 leading-relaxed" x-text="`${selectedCompany.company} is a dynamic company operating in the technology sector. They focus on innovation and delivering cutting-edge solutions to their clients. With operations across multiple locations, they maintain a strong presence in the market and are actively seeking talented professionals to join their growing team.`"></p>
                    </div>

                    <!-- Company Information Card -->
                    <div class="bg-white border-2 border-gray-200 rounded-lg p-4 mb-4">
                        <h4 class="text-base font-bold text-gray-900 mb-4">Company Information</h4>
                        <div class="space-y-4">
                            <!-- Status Selector -->
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-2">Status</label>
                                <select 
                                    x-model="selectedCompany.status"
                                    @change="updateCompanyStatus()"
                                    :class="updatingFields.status === true ? 'animate-pulse bg-blue-50' : ''"
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
                                    :disabled="updatingFields.status === true"
                                >
                                    <option value="Undecided">Undecided</option>
                                    <option value="Prospect">Prospect</option>
                                    <option value="Follow up">Follow up</option>
                                    <option value="Qualified">Qualified</option>
                                    <option value="Qualify out competition">Qualify out competition</option>
                                    <option value="Qualify out wrong info">Qualify out wrong info</option>
                                    <option value="Rejected">Rejected</option>
                                    <option value="Customer">Customer</option>
                                </select>
                            </div>
                            
                            <!-- Company Type Selector -->
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-2">Company Type</label>
                                <select 
                                    x-model="selectedCompany.company_type"
                                    @change="updateCompanyField('company_type', selectedCompany.company_type)"
                                    :class="updatingFields.company_type === true ? 'animate-pulse bg-blue-50' : ''"
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
                                    :disabled="updatingFields.company_type === true"
                                >
                                    <option value="">-- Select Type --</option>
                                    <option value="Consulting (Business)">Consulting (Business)</option>
                                    <option value="Consulting (Technology)">Consulting (Technology)</option>
                                    <option value="Technology">Technology</option>
                                    <option value="Finance">Finance</option>
                                    <option value="Retail">Retail</option>
                                    <option value="Manufacturing">Manufacturing</option>
                                    <option value="Healthcare">Healthcare</option>
                                    <option value="Education">Education</option>
                                    <option value="Government">Government</option>
                                    <option value="Energy">Energy</option>
                                    <option value="Logistics">Logistics</option>
                                    <option value="Hospitality">Hospitality</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            
                            <!-- Solution Domain Selector -->
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-2">Solution Domain</label>
                                <select 
                                    x-model="selectedCompany.solution_domain"
                                    @change="updateCompanyField('solution_domain', selectedCompany.solution_domain)"
                                    :class="updatingFields.solution_domain === true ? 'animate-pulse bg-blue-50' : ''"
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
                                    :disabled="updatingFields.solution_domain === true"
                                >
                                    <option value="">-- Select Domain --</option>
                                    <option value="Data">Data</option>
                                    <option value="Marketing">Marketing</option>
                                    <option value="All">All</option>
                                </select>
                            </div>
                            
                            <!-- Job Openings -->
                            <div class="flex items-center justify-between pt-2 border-t border-gray-100">
                                <span class="text-sm font-medium text-gray-600">Job Openings</span>
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800">
                                    <span x-text="selectedCompany.job_count"></span> <span x-text="selectedCompany.job_count === 1 ? 'opening' : 'openings'"></span>
                                </span>
                            </div>
                            
                            <!-- Geographic Reach -->
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-gray-600">Geographic Reach</span>
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-purple-100 text-purple-800">
                                    <span x-text="selectedCompany.countries ? selectedCompany.countries.length : 0"></span> <span x-text="(selectedCompany.countries?.length || 0) === 1 ? 'country' : 'countries'"></span>
                                </span>
                            </div>
                            
                            <!-- Company Industry -->
                            <div x-show="selectedCompany.company_industry" class="pt-2 border-t border-gray-100">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Industry</label>
                                <p class="text-sm text-gray-800" x-text="selectedCompany.company_industry"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Job Listings Section -->
                    <div class="bg-white border-2 border-gray-200 rounded-xl p-5 mb-5">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-base font-bold text-gray-900">Job Openings</h4>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800">
                                <span x-text="selectedCompany.job_count"></span> <span x-text="selectedCompany.job_count === 1 ? 'job' : 'jobs'"></span>
                            </span>
                        </div>
                        
                        <!-- Scrollable Job List -->
                        <div class="space-y-3 max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                            <!-- Loading State -->
                            <div x-show="!companyJobs" class="text-center py-8">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                                <p class="mt-2 text-sm text-gray-500">Loading jobs...</p>
                            </div>
                            
                            <!-- No Jobs State -->
                            <div x-show="companyJobs && companyJobs.length === 0" class="text-center py-8">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <p class="mt-2 text-sm text-gray-500">No jobs found</p>
                            </div>
                            
                            <!-- Jobs List -->
                            <template x-for="(job, index) in companyJobs" :key="index">
                                <div 
                                    class="p-4 border border-gray-200 rounded-lg hover:border-blue-500 hover:shadow-md transition-all cursor-pointer bg-white"
                                >
                                    <h5 class="font-semibold text-gray-900 mb-2 text-sm" x-text="job.title"></h5>
                                    
                                    <!-- Job Description Preview -->
                                    <p x-show="job.description" class="text-xs text-gray-600 mb-3 line-clamp-2" x-text="job.description"></p>
                                    
                                    <!-- Location and Tech Stack -->
                                    <div class="flex flex-wrap gap-2 text-xs text-gray-600 mb-2">
                                        <span x-show="job.location" class="flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                            </svg>
                                            <span x-text="job.location"></span>
                                        </span>
                                        <span x-show="job.search_keyword" class="inline-flex items-center px-2 py-0.5 rounded bg-gradient-to-r from-blue-50 to-purple-50 text-blue-700 font-medium">
                                            <span x-text="job.search_keyword"></span>
                                        </span>
                                    </div>
                                    
                                    <!-- Footer -->
                                    <div class="flex items-center justify-between pt-2 border-t border-gray-100">
                                        <span class="text-xs text-gray-500" x-text="formatDate(job.scraped_at)"></span>
                                        <div class="flex items-center gap-2">
                                            <a 
                                                :href="`/dashboard/jobs/?company=${encodeURIComponent(job.company_name)}`"
                                                class="text-xs font-medium text-blue-600 hover:text-blue-800 flex items-center gap-1"
                                            >
                                                View Details
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                                </svg>
                                            </a>
                                            <a 
                                                x-show="job.url"
                                                :href="job.url" 
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                class="text-xs font-medium text-green-600 hover:text-green-800 flex items-center gap-1"
                                            >
                                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                                </svg>
                                                LinkedIn
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- All Details -->
                    <div class="space-y-5">
                        <!-- Locations Section -->
                        <div x-show="selectedCompany.locations && selectedCompany.locations.length > 0">
                            <h4 class="text-sm font-semibold text-gray-900 mb-2">Locations</h4>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="location in selectedCompany.locations" :key="location">
                                    <span class="px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-800" x-text="location"></span>
                                </template>
                            </div>
                        </div>

                        <!-- Countries Section -->
                        <div x-show="selectedCompany.countries && selectedCompany.countries.length > 0">
                            <h4 class="text-sm font-semibold text-gray-900 mb-2">Countries</h4>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="country in selectedCompany.countries" :key="country">
                                    <span class="px-3 py-1 rounded-full text-sm bg-green-100 text-green-800" x-text="country"></span>
                                </template>
                            </div>
                        </div>

                        <!-- Sources Section -->
                        <div x-show="selectedCompany.sources && selectedCompany.sources.length > 0">
                            <h4 class="text-sm font-semibold text-gray-900 mb-2">Job Sources</h4>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="source in selectedCompany.sources" :key="source">
                                    <span 
                                        class="px-3 py-1 rounded-full text-sm"
                                        :class="{
                                            'bg-blue-100 text-blue-800': source.toLowerCase().includes('linkedin'),
                                            'bg-purple-100 text-purple-800': source.toLowerCase().includes('adzuna'),
                                            'bg-gray-100 text-gray-800': !source.toLowerCase().includes('linkedin') && !source.toLowerCase().includes('adzuna')
                                        }"
                                        x-text="source"
                                    ></span>
                                </template>
                            </div>
                        </div>

                        <!-- Tech Stack Section -->
                        <div x-show="selectedCompany.tech_stacks && selectedCompany.tech_stacks.length > 0">
                            <h4 class="text-sm font-semibold text-gray-900 mb-2">Tech Stack</h4>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="tech in selectedCompany.tech_stacks" :key="tech">
                                    <span class="px-3 py-1 rounded-full text-sm bg-gradient-to-r from-blue-50 to-pink-50 text-gray-700 border border-blue-200" x-text="tech"></span>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="pt-4 space-y-3">
                        <a
                            :href="`/dashboard/jobs?keyword=${encodeURIComponent(selectedCompany.company)}`"
                            class="inline-flex items-center justify-center w-full px-6 py-3 text-base font-medium text-white bg-gradient-to-r from-blue-600 to-pink-600 rounded-lg hover:from-blue-700 hover:to-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200"
                        >
                            <span>View all <span x-text="selectedCompany.job_count"></span> <span x-text="selectedCompany.job_count === 1 ? 'job' : 'jobs'"></span></span>
                            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                            </svg>
                        </a>
                        
                        <button
                            @click="getContactDetails()"
                            class="inline-flex items-center justify-center w-full px-6 py-3 text-base font-medium text-white bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg hover:from-purple-700 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-200"
                        >
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            <span>Get Contact Details (AI)</span>
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>
    </div> <!-- End Companies + Details Wrapper -->

    <!-- Backdrop Overlay -->
    <div
        x-show="showAiChat"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        @click="showAiChat = false; chatMessages = []; chatInput = ''"
        class="fixed inset-0 bg-black bg-opacity-50 z-[60]"
        style="display: none;"
    ></div>

    <!-- Contact Details Sliding Panel - Fixed Overlay -->
    <div
        x-show="showAiChat"
        x-transition:enter="transition ease-out duration-500"
        x-transition:enter-start="opacity-0 transform translate-x-full"
        x-transition:enter-end="opacity-100 transform translate-x-0"
        x-transition:leave="transition ease-in duration-500"
        x-transition:leave-start="opacity-100 transform translate-x-0"
        x-transition:leave-end="opacity-0 transform translate-x-full"
        class="fixed right-0 top-0 bottom-0 bg-white shadow-2xl flex flex-col z-[70] w-full max-w-[28rem]"
        style="display: none;"
    >
        <!-- Chat Header -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-4 flex items-center justify-between flex-shrink-0">
            <div class="flex items-center space-x-3">
                <div class="bg-white rounded-full p-2">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
                <div>
                    <h2 class="text-lg font-bold">Columbus Assistant</h2>
                    <p class="text-sm opacity-90" x-text="selectedCompany?.company || 'Company'"></p>
                </div>
            </div>
            <button
                @click="showAiChat = false; chatMessages = []; chatInput = ''"
                class="text-white hover:text-gray-200 transition-colors"
            >
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Chat Messages -->
        <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50" id="chatMessagesContainer">
            <!-- Columbus AI Status Card (Reactive) -->
            <div x-show="researchStatus.active" class="mb-4">
                <div 
                    class="bg-gradient-to-r rounded-lg px-6 py-4 shadow-lg border-2 transition-all duration-700"
                    :class="{
                        'from-blue-500 to-blue-600 border-blue-300': researchStatus.status === 'thinking',
                        'from-indigo-500 to-indigo-600 border-indigo-300': researchStatus.status === 'fetching',
                        'from-purple-500 to-purple-600 border-purple-300': researchStatus.status === 'rag',
                        'from-green-500 to-green-600 border-green-300': researchStatus.status === 'browsing' || researchStatus.status === 'complete',
                        'from-yellow-500 to-yellow-600 border-yellow-300': researchStatus.status === 'summarizing',
                        'from-red-500 to-red-600 border-red-300': researchStatus.status === 'error'
                    }"
                >
                    <div class="flex items-center gap-4">
                        <!-- Animated Columbus Logo -->
                        <div class="flex-shrink-0">
                            <svg class="w-12 h-12 text-white animate-spin-slow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10" stroke-width="2"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2v4M12 18v4M22 12h-4M6 12H2"/>
                                <circle cx="12" cy="12" r="3" fill="currentColor"/>
                            </svg>
                        </div>
                        
                        <!-- Status Content -->
                        <div class="flex-1 text-white">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-2xl" x-text="researchStatus.icon"></span>
                                <p class="font-bold text-lg" x-text="researchStatus.message"></p>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="w-full bg-white bg-opacity-30 rounded-full h-2 overflow-hidden">
                                <div 
                                    class="bg-white h-full transition-all duration-700 rounded-full"
                                    :style="`width: ${researchStatus.progress}%`"
                                ></div>
                            </div>
                            <p class="text-sm mt-1 text-white text-opacity-90" x-text="`${researchStatus.progress}% complete`"></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chat Messages -->
            <template x-for="(msg, index) in chatMessages" :key="index">
                <div>
                    <!-- User Messages -->
                    <template x-if="msg.role === 'user'">
                        <div class="flex justify-end mb-4">
                            <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg px-5 py-3 shadow-md" style="max-width: 80%">
                                <div class="text-sm font-medium leading-relaxed" x-text="msg.content"></div>
                            </div>
                        </div>
                    </template>
                    
                    <!-- Assistant Messages -->
                    <template x-if="msg.role === 'assistant'">
                        <div class="flex justify-start mb-4">
                            <div class="bg-white border-2 border-purple-200 rounded-lg px-5 py-3 shadow-md" style="max-width: 85%">
                                <div class="flex items-start mb-2">
                                    <div class="bg-gradient-to-br from-purple-500 to-blue-600 rounded-full p-1.5 mr-2 flex-shrink-0">
                                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                        </svg>
                                    </div>
                                    <div class="text-xs font-semibold text-purple-600">ColumbusAI Agent</div>
                                </div>
                                <div class="text-sm text-gray-800 leading-relaxed ai-message-content" x-html="msg.content"></div>
                            </div>
                        </div>
                    </template>
                </div>
            </template>

            <!-- Loading Indicator (fallback) -->
            <div x-show="aiLoading" class="flex justify-start">
                <div class="bg-white border-2 border-purple-200 rounded-lg px-5 py-4 shadow-lg">
                    <div class="flex items-start mb-2">
                        <div class="bg-gradient-to-br from-purple-500 to-blue-600 rounded-full p-1.5 mr-2 flex-shrink-0">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                        </div>
                        <div class="text-xs font-semibold text-purple-600">Processing...</div>
                    </div>
                    <div class="flex space-x-2">
                        <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="border-t border-gray-200 p-4 bg-white flex-shrink-0">
            <div class="flex space-x-2">
                <input
                    type="text"
                    x-model="chatInput"
                    @keydown.enter="sendChatMessage()"
                    placeholder="Ask a follow-up question..."
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
                <button
                    @click="sendChatMessage()"
                    :disabled="!chatInput.trim() || aiLoading"
                    class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-2 rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                    <span>Send</span>
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-2">Powered by Google Gemini 2.5 Pro</p>
        </div>
    </div>
</div>

<script>
function companiesData() {
    return {
        companies: {{ companies|safe }},
        loading: false,
        error: null,
        selectedCompany: null,
        showAiChat: false,
        aiLoading: false,
        chatMessages: [],
        chatInput: '',
        showAllTechs: false,
        availableTechs: {{ filter_options.tech_stacks|safe }},
        selectedTechs: [],
        showTechDropdown: false,
        showStatusDropdown: false,
        selectedStatuses: [],
        hasRoomForBoth: true,
        companyJobs: null,
        selectedJob: null,
        updatingFields: {},  // Track which fields are being updated
        displayedCount: 20,  // Initially show 20 companies
        loadMoreThreshold: 500,  // Load more when scrolled within 500px of bottom
        // Columbus AI Status tracking
        researchStatus: {
            active: false,
            icon: 'ðŸ§ ',
            message: '',
            status: 'thinking',
            progress: 0
        },
        filters: {
            relevant: '{{ filters.relevant|default:"to_review" }}',
            status: '{{ filters.status }}',
            keyword: '{{ filters.keyword }}',
            country: '{{ filters.country }}',
            min_jobs: {{ filters.min_jobs|default:1 }},
            sort_by: '{{ filters.sort_by|default:"company_name" }}',
            limit: {{ filters.limit|default:10000 }}
        },
        
        get visibleCompanies() {
            return this.companies.slice(0, this.displayedCount);
        },

        init() {
            console.log('Companies page initialized with', this.companies.length, 'companies');
            
            // Sort filter options alphabetically
            if (this.availableTechs && Array.isArray(this.availableTechs)) {
                this.availableTechs.sort((a, b) => a.localeCompare(b));
            }
            
            // Check available space
            this.checkSpaceAvailability();
            
            // Force re-render on window resize to update :class bindings
            window.addEventListener('resize', () => {
                this.checkSpaceAvailability();
                this.$nextTick(() => {
                    // Trigger Alpine reactivity
                });
            });
            
            // Sort companies alphabetically if no sort parameter in URL
            const urlParams = new URLSearchParams(window.location.search);
            if (!urlParams.has('sort_by')) {
                this.companies.sort((a, b) => {
                    const nameA = (a.company || '').toLowerCase();
                    const nameB = (b.company || '').toLowerCase();
                    return nameA.localeCompare(nameB);
                });
                console.log('Sorted companies alphabetically A-Z');
            }
            
            // Initialize selected techs from URL params
            const techParam = urlParams.get('tech_stack');
            if (techParam) {
                this.selectedTechs = techParam.split(',');
            }
            
            // Setup scroll listener for lazy loading
            window.addEventListener('scroll', () => {
                const scrollY = window.scrollY;
                const windowHeight = window.innerHeight;
                const documentHeight = document.documentElement.scrollHeight;
                
                // Load more when within threshold of bottom
                if (scrollY + windowHeight >= documentHeight - this.loadMoreThreshold) {
                    if (this.displayedCount < this.companies.length) {
                        this.displayedCount = Math.min(this.displayedCount + 20, this.companies.length);
                        console.log('Loaded more companies. Showing:', this.displayedCount, 'of', this.companies.length);
                    }
                }
            });
        },
        
        loadAllCompanies() {
            this.displayedCount = this.companies.length;
            console.log('Loaded all', this.companies.length, 'companies');
        },

        applyStatusFilter() {
            // Update the filters.status to match selected statuses
            if (this.selectedStatuses.length === 0) {
                this.filters.status = '';
            } else if (this.selectedStatuses.length === 1) {
                this.filters.status = this.selectedStatuses[0];
            } else {
                // For multiple statuses, we'll need to handle this in the backend
                // For now, just use the first one
                this.filters.status = this.selectedStatuses[0];
            }
            this.applyFilters();
        },
        
        toggleTech(tech) {
            const index = this.selectedTechs.indexOf(tech);
            if (index > -1) {
                this.selectedTechs.splice(index, 1);
            } else {
                this.selectedTechs.push(tech);
            }
            this.applyFilters();
        },

        clearSelectedTechs() {
            this.selectedTechs = [];
            this.applyFilters();
        },

        async updateCompanyStatus() {
            console.log('Update company status:', this.selectedCompany.company, this.selectedCompany.status);
            
            this.updatingFields.status = true;
            
            try {
                const response = await fetch('/dashboard/companies/update/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        company_name: this.selectedCompany.company,
                        updates: {
                            status: this.selectedCompany.status
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('Status updated successfully:', result);
                    // Show success message
                    this.showToast('Status updated successfully', 'success');
                } else {
                    console.error('Failed to update status:', result.error);
                    this.showToast('Failed to update status: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                this.showToast('Error updating status: ' + error.message, 'error');
            } finally {
                this.updatingFields.status = false;
            }
        },
        
        showToast(message, type = 'info') {
            // Simple toast notification (you can enhance this)
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        },
        
        async updateCompanyField(field, value) {
            console.log(`Update company ${field}:`, this.selectedCompany.company, value);
            
            this.updatingFields[field] = true;
            
            try {
                const response = await fetch('/dashboard/companies/update/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        company_name: this.selectedCompany.company,
                        updates: {
                            [field]: value
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log(`${field} updated successfully:`, result);
                    this.showToast(`${field.replace('_', ' ')} updated successfully`, 'success');
                } else {
                    console.error(`Failed to update ${field}:`, result.error);
                    this.showToast(`Failed to update ${field}: ` + result.error, 'error');
                }
            } catch (error) {
                console.error(`Error updating ${field}:`, error);
                this.showToast(`Error updating ${field}: ` + error.message, 'error');
            } finally {
                this.updatingFields[field] = false;
            }
        },

        async loadCompanyJobs() {
            if (!this.selectedCompany) return;
            
            try {
                // Fetch jobs for this company from the API
                const response = await fetch(`/dashboard/jobs/api/list/?keyword=${encodeURIComponent(this.selectedCompany.company)}&limit=100`);
                if (!response.ok) throw new Error('Failed to fetch jobs');
                
                const data = await response.json();
                this.companyJobs = data.jobs || [];
                console.log('Loaded jobs for', this.selectedCompany.company, ':', this.companyJobs.length, 'jobs', this.companyJobs);
            } catch (error) {
                console.error('Error loading company jobs:', error);
                // Fallback: redirect to jobs page
                window.location.href = `/dashboard/jobs?keyword=${encodeURIComponent(this.selectedCompany.company)}`;
            }
        },

        viewJob(job) {
            // Open job source in new tab
            if (job.url) {
                window.open(job.url, '_blank');
            }
        },

        applyFilters() {
            // Build URL with query params - skip empty values
            const params = new URLSearchParams();
            
            // Always include relevant filter (default to 'relevant')
            if (this.filters.relevant) {
                params.append('relevant', this.filters.relevant);
            }
            
            // Add status filter
            if (this.filters.status) {
                params.append('status', this.filters.status);
            }
            
            if (this.filters.keyword && this.filters.keyword.trim()) {
                params.append('keyword', this.filters.keyword.trim());
            }
            if (this.filters.country) {
                params.append('country', this.filters.country);
            }
            if (this.selectedTechs.length > 0) {
                params.append('tech_stack', this.selectedTechs.join(','));
            }
            if (this.filters.min_jobs && this.filters.min_jobs > 1) {
                params.append('min_jobs', this.filters.min_jobs);
            }
            if (this.filters.sort_by) {
                params.append('sort_by', this.filters.sort_by);
            }
            if (this.filters.limit) {
                params.append('limit', this.filters.limit);
            }
            
            // Reload page with filters
            window.location.href = `/dashboard/companies?${params.toString()}`;
        },

        resetFilters() {
            window.location.href = '/dashboard/companies';
        },

        checkSpaceAvailability() {
            // Check if there's enough space (300px) for companies section when details are open
            // Filters are always horizontal navbar when company selected (height, not width)
            // Details panel (384px), and companies (300px min)
            const windowWidth = window.innerWidth;
            const detailsWidth = 384; // 24rem
            const minCompaniesWidth = 300; // Minimum to show at least one company
            const totalRequired = detailsWidth + minCompaniesWidth;
            
            this.hasRoomForBoth = windowWidth >= totalRequired;
            console.log('Space check:', { windowWidth, detailsWidth, minCompaniesWidth, totalRequired, hasRoomForBoth: this.hasRoomForBoth });
        },
        
        selectCompany(company) {
            this.selectedCompany = company;
            this.showAiChat = false;
            this.chatMessages = [];
            this.chatInput = '';
            this.companyJobs = null;  // Reset jobs - will show loading
            this.selectedJob = null;
            
            // Check space when selecting company
            this.checkSpaceAvailability();
            
            // Automatically load jobs for this company
            this.loadCompanyJobs();
        },

        formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        },

        getTechStackColor(tech) {
            const techLower = tech.toLowerCase();
            
            // Cloud Platforms - Blue
            if (['gcp', 'google cloud', 'aws', 'azure', 'cloud'].some(t => techLower.includes(t))) {
                return 'bg-blue-50 text-blue-700 border-blue-200';
            }
            
            // Data & Analytics - Purple
            if (['bigquery', 'looker', 'tableau', 'power bi', 'data studio', 'analytics', 'dataflow', 'data'].some(t => techLower.includes(t))) {
                return 'bg-purple-50 text-purple-700 border-purple-200';
            }
            
            // AI & Machine Learning - Pink
            if (['vertex ai', 'gemini', 'ai', 'ml', 'machine learning', 'tensorflow', 'pytorch', 'automl'].some(t => techLower.includes(t))) {
                return 'bg-pink-50 text-pink-700 border-pink-200';
            }
            
            // Databases - Green
            if (['sql', 'postgres', 'mysql', 'mongodb', 'database', 'spanner', 'firestore'].some(t => techLower.includes(t))) {
                return 'bg-green-50 text-green-700 border-green-200';
            }
            
            // DevOps & Infrastructure - Orange
            if (['kubernetes', 'docker', 'terraform', 'jenkins', 'ci/cd', 'devops', 'ansible'].some(t => techLower.includes(t))) {
                return 'bg-orange-50 text-orange-700 border-orange-200';
            }
            
            // Programming Languages - Indigo
            if (['python', 'java', 'javascript', 'typescript', 'go', 'rust', 'c++', 'c#'].some(t => techLower.includes(t))) {
                return 'bg-indigo-50 text-indigo-700 border-indigo-200';
            }
            
            // Business & Strategy - Teal
            if (['strategy', 'consulting', 'business', 'crm', 'erp', 'salesforce'].some(t => techLower.includes(t))) {
                return 'bg-teal-50 text-teal-700 border-teal-200';
            }
            
            // Messaging & Integration - Amber
            if (['pub/sub', 'kafka', 'rabbitmq', 'api', 'integration', 'webhook'].some(t => techLower.includes(t))) {
                return 'bg-amber-50 text-amber-700 border-amber-200';
            }
            
            // Default - Gray
            return 'bg-gray-50 text-gray-700 border-gray-200';
        },

        formatContactDetailsHTML(data) {
            let html = '<div class="space-y-4 text-sm">';
            
            // Company Info Section
            if (data.company) {
                html += `
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-200">
                        <h3 class="font-bold text-lg text-gray-900 mb-3 flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"/>
                            </svg>
                            ${data.company.name}
                        </h3>
                        ${data.company.website ? `<p class="mb-2"><span class="font-semibold text-gray-700">Website:</span> <a href="${data.company.website}" target="_blank" class="text-blue-600 hover:underline">${data.company.website}</a></p>` : ''}
                        ${data.company.linkedin_company ? `<p class="mb-2"><span class="font-semibold text-gray-700">LinkedIn:</span> <a href="${data.company.linkedin_company}" target="_blank" class="text-blue-600 hover:underline inline-flex items-center gap-1"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M16.338 16.338H13.67V12.16c0-.995-.017-2.277-1.387-2.277-1.39 0-1.601 1.086-1.601 2.207v4.248H8.014v-8.59h2.559v1.174h.037c.356-.675 1.227-1.387 2.526-1.387 2.703 0 3.203 1.778 3.203 4.092v4.711zM5.005 6.575a1.548 1.548 0 11-.003-3.096 1.548 1.548 0 01.003 3.096zm-1.337 9.763H6.34v-8.59H3.667v8.59zM17.668 1H2.328C1.595 1 1 1.581 1 2.298v15.403C1 18.418 1.595 19 2.328 19h15.34c.734 0 1.332-.582 1.332-1.299V2.298C19 1.581 18.402 1 17.668 1z"/></svg> Company Page</a></p>` : ''}
                        ${data.company.headquarters ? `<p class="mb-2"><span class="font-semibold text-gray-700">Headquarters:</span> ${data.company.headquarters}</p>` : ''}
                        ${data.company.description ? `<p class="text-gray-600 text-xs mt-3 leading-relaxed">${data.company.description}</p>` : ''}
                    </div>
                `;
            }
            
            // General Contact Section
            if (data.general_contact && (data.general_contact.email || data.general_contact.phone || data.general_contact.contact_form)) {
                html += `
                    <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                        <h3 class="font-bold text-base text-gray-900 mb-2 flex items-center gap-2">
                            <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                            </svg>
                            General Contact
                        </h3>
                        ${data.general_contact.email ? `<p class="mb-1"><span class="font-semibold text-gray-700">Email:</span> <a href="mailto:${data.general_contact.email}" class="text-green-700 hover:underline">${data.general_contact.email}</a></p>` : ''}
                        ${data.general_contact.phone ? `<p class="mb-1"><span class="font-semibold text-gray-700">Phone:</span> <a href="tel:${data.general_contact.phone}" class="text-green-700 hover:underline">${data.general_contact.phone}</a></p>` : ''}
                        ${data.general_contact.contact_form ? `<p><span class="font-semibold text-gray-700">Contact Form:</span> <a href="${data.general_contact.contact_form}" target="_blank" class="text-green-700 hover:underline">Visit Form</a></p>` : ''}
                    </div>
                `;
            }
            
            // Decision Makers Section
            if (data.decision_makers && data.decision_makers.length > 0) {
                html += `
                    <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                        <h3 class="font-bold text-base text-gray-900 mb-3 flex items-center gap-2">
                            <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                            </svg>
                            Decision Makers (${data.decision_makers.length})
                        </h3>
                        <div class="space-y-3">
                `;
                
                data.decision_makers.forEach((person, idx) => {
                    const confidenceColor = person.confidence === 'high' ? 'bg-green-100 text-green-800' : 
                                          person.confidence === 'medium' ? 'bg-yellow-100 text-yellow-800' : 
                                          'bg-gray-100 text-gray-800';
                    
                    html += `
                        <div class="bg-white rounded-lg p-3 border border-purple-200">
                            <div class="flex items-start justify-between mb-2">
                                <div>
                                    <p class="font-bold text-gray-900">${person.name}</p>
                                    <p class="text-xs text-purple-700 font-medium">${person.title}</p>
                                    ${person.department ? `<p class="text-xs text-gray-600 mt-0.5">${person.department}</p>` : ''}
                                </div>
                                <span class="px-2 py-1 rounded text-xs font-semibold ${confidenceColor}">${person.confidence}</span>
                            </div>
                            ${person.linkedin_url ? `<p class="mb-1"><a href="${person.linkedin_url}" target="_blank" class="text-blue-600 hover:underline text-xs inline-flex items-center gap-1"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M16.338 16.338H13.67V12.16c0-.995-.017-2.277-1.387-2.277-1.39 0-1.601 1.086-1.601 2.207v4.248H8.014v-8.59h2.559v1.174h.037c.356-.675 1.227-1.387 2.526-1.387 2.703 0 3.203 1.778 3.203 4.092v4.711zM5.005 6.575a1.548 1.548 0 11-.003-3.096 1.548 1.548 0 01.003 3.096zm-1.337 9.763H6.34v-8.59H3.667v8.59zM17.668 1H2.328C1.595 1 1 1.581 1 2.298v15.403C1 18.418 1.595 19 2.328 19h15.34c.734 0 1.332-.582 1.332-1.299V2.298C19 1.581 18.402 1 17.668 1z"/></svg> LinkedIn Profile</a></p>` : ''}
                            ${person.email ? `<p class="text-xs"><a href="mailto:${person.email}" class="text-purple-700 hover:underline">${person.email}</a></p>` : ''}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Social Media Section
            if (data.social_media && (data.social_media.twitter || data.social_media.facebook || data.social_media.youtube)) {
                html += `
                    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                        <h3 class="font-bold text-base text-gray-900 mb-2">Social Media</h3>
                        <div class="flex flex-wrap gap-2">
                            ${data.social_media.twitter ? `<a href="${data.social_media.twitter}" target="_blank" class="inline-flex items-center gap-1 px-3 py-1.5 bg-sky-500 text-white rounded-lg hover:bg-sky-600 text-xs font-medium"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg> Twitter</a>` : ''}
                            ${data.social_media.facebook ? `<a href="${data.social_media.facebook}" target="_blank" class="inline-flex items-center gap-1 px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-xs font-medium"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg> Facebook</a>` : ''}
                            ${data.social_media.youtube ? `<a href="${data.social_media.youtube}" target="_blank" class="inline-flex items-center gap-1 px-3 py-1.5 bg-red-600 text-white rounded-lg hover:bg-red-700 text-xs font-medium"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 00-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 00.502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 002.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 002.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg> YouTube</a>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Notes Section
            if (data.notes) {
                html += `
                    <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                        <h3 class="font-bold text-base text-gray-900 mb-2 flex items-center gap-2">
                            <svg class="w-4 h-4 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/>
                            </svg>
                            Verification Notes
                        </h3>
                        <p class="text-xs text-gray-700 leading-relaxed">${data.notes}</p>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        },

        async getContactDetails() {
            if (!this.selectedCompany) return;

            this.showAiChat = true;
            this.aiLoading = false;
            this.chatMessages = []; // Clear previous messages

            // Activate Columbus AI status
            this.researchStatus.active = true;
            this.researchStatus.icon = 'ðŸ§ ';
            this.researchStatus.message = 'ColumbusAI is analyzing your request...';
            this.researchStatus.status = 'thinking';
            this.researchStatus.progress = 10;

            // Scroll to show status
            await this.$nextTick();
            this.scrollToBottom();

            try {
                console.log('Starting streaming request for company:', this.selectedCompany.company_id);
                
                // Connect to streaming endpoint with company_id
                const response = await fetch('/dashboard/companies/research-streaming/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        company_id: this.selectedCompany.company_id 
                    })
                });

                console.log('Streaming response received:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Streaming error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                
                                if (data.status === 'result') {
                                    // Hide status and show final results
                                    this.researchStatus.active = false;
                                    
                                    // Display final contact results
                                    this.displayContactResults(data.data);
                                } else if (data.status === 'error') {
                                    this.researchStatus.icon = 'âŒ';
                                    this.researchStatus.message = data.message;
                                    this.researchStatus.status = 'error';
                                    this.researchStatus.progress = 100;
                                } else {
                                    // Update reactive status
                                    console.log('Status update:', data);
                                    this.researchStatus.icon = data.icon || 'ðŸ¤–';
                                    this.researchStatus.message = data.message;
                                    this.researchStatus.status = data.status;
                                    this.researchStatus.progress = data.progress || 0;
                                    console.log('Research status updated:', this.researchStatus);
                                    await this.$nextTick();
                                    this.scrollToBottom();
                                }
                            } catch (e) {
                                console.error('Error parsing SSE data:', e);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Streaming error:', error);
                this.researchStatus.active = false;
                this.chatMessages.push({
                    role: 'assistant',
                    content: `<div class="text-red-600 font-medium">âš ï¸ Connection Error</div><div class="mt-1 text-sm">${error.message}</div>`
                });
            } finally {
                this.aiLoading = false;
            }
        },

        showStatusMessage(icon, message, status, progress = 0) {
            console.log('showStatusMessage called:', { icon, message, status, progress });
            const statusDiv = document.getElementById('columbusStatus');
            console.log('Status div found:', statusDiv);
            if (!statusDiv) {
                console.error('Status div not found!');
                return;
            }
            
            const statusColors = {
                'thinking': 'from-blue-500 to-blue-600',
                'fetching': 'from-indigo-500 to-indigo-600',
                'rag': 'from-purple-500 to-purple-600',
                'browsing': 'from-green-500 to-green-600',
                'summarizing': 'from-yellow-500 to-yellow-600',
                'complete': 'from-green-600 to-green-700',
                'error': 'from-red-500 to-red-600'
            };
            
            const gradientClass = statusColors[status] || 'from-gray-500 to-gray-600';
            const isComplete = status === 'complete';
            
            statusDiv.innerHTML = `
                <div class="bg-gradient-to-r ${gradientClass} text-white rounded-xl p-6 shadow-2xl ${isComplete ? '' : 'animate-pulse'}">
                    <div class="flex items-center space-x-4 mb-3">
                        <div class="bg-white bg-opacity-20 rounded-full p-3 backdrop-blur-sm">
                            <div class="text-4xl">${icon}</div>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-1">
                                <svg class="w-6 h-6 animate-spin-slow" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z"/>
                                </svg>
                                <div class="font-bold text-xl tracking-wide">ColumbusAI</div>
                            </div>
                            <div class="text-sm opacity-95 font-medium">${message}</div>
                        </div>
                    </div>
                    ${progress > 0 ? `
                    <div class="mt-4">
                        <div class="flex justify-between text-xs mb-1 font-semibold">
                            <span>Progress</span>
                            <span>${progress}%</span>
                        </div>
                        <div class="w-full bg-white bg-opacity-20 rounded-full h-3 overflow-hidden backdrop-blur-sm">
                            <div class="bg-white h-full rounded-full transition-all duration-700 ease-out shadow-lg" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        },

        displayContactResults(data) {
            // Check if we have a formatted message (new format)
            if (data.message) {
                // Use the pre-formatted markdown message
                const markdownHTML = marked.parse(data.message);
                this.chatMessages.push({
                    role: 'assistant',
                    content: markdownHTML
                });
            } else {
                // Fallback to old format
                const research = data.research_result || {};
                const contactDetails = research.contact_details || {};
                
                // Parse if it's a string
                let parsedDetails = contactDetails;
                if (typeof contactDetails === 'string') {
                    try {
                        // Try to extract JSON from markdown code block
                        const jsonMatch = contactDetails.match(/```json\s*([\s\S]*?)\s*```/);
                        if (jsonMatch) {
                            parsedDetails = JSON.parse(jsonMatch[1]);
                        } else {
                            parsedDetails = JSON.parse(contactDetails);
                        }
                    } catch (e) {
                        console.error('Failed to parse contact details:', e);
                        parsedDetails = { raw: contactDetails };
                    }
                }
                
                // Format and display
                const formattedHTML = this.formatContactDetailsHTML(parsedDetails);
                
                this.chatMessages.push({
                    role: 'assistant',
                    content: formattedHTML
                });
            }
            
            // Scroll to show results
            this.$nextTick(() => this.scrollToBottom());
        },

        scrollToBottom() {
            const container = document.getElementById('chatMessagesContainer');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        },

        async sendChatMessage() {
            if (!this.chatInput.trim() || this.aiLoading) return;

            const message = this.chatInput.trim();
            this.chatInput = '';
            this.aiLoading = true;

            // Add user message
            this.chatMessages.push({
                role: 'user',
                content: message
            });

            try {
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                  document.querySelector('meta[name="csrf-token"]')?.content;
                
                const response = await fetch('/dashboard/companies/contact-details/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body: JSON.stringify({
                        company_name: this.selectedCompany.company,
                        question: message
                    })
                });

                const data = await response.json();

                if (data.success) {
                    this.chatMessages.push({
                        role: 'assistant',
                        content: data.contact_details
                    });
                } else {
                    this.chatMessages.push({
                        role: 'assistant',
                        content: `<span class="text-red-600">Error: ${data.error}</span>`
                    });
                }
            } catch (error) {
                console.error('Error sending message:', error);
                this.chatMessages.push({
                    role: 'assistant',
                    content: `<span class="text-red-600">Error: ${error.message}</span>`
                });
            } finally {
                this.aiLoading = false;
            }
        }
    }
}
</script>
{% endblock %}
