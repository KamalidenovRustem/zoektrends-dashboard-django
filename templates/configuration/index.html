{% extends 'base.html' %}
{% load static %}

{% block title %}Scraping Configuration - Columbus AI{% endblock %}

{% block extra_head %}
<style>
    [x-cloak] {
        display: none !important;
    }
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div 
    x-data="configurationData()"
    x-init="init()"
    class="h-[calc(100vh-64px)] bg-gray-50 overflow-hidden flex flex-col"
>
    <!-- Header -->
    <div class="bg-white border-b border-gray-200 px-6 py-4">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Scraping Configuration</h1>
                <p class="text-sm text-gray-600 mt-1">
                    Manage job scraping configurations for automated runs
                </p>
            </div>
            <div class="flex gap-2">
                <button
                    @click="loadConfigurations()"
                    class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all shadow-md"
                >
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Reload
                </button>
                <button
                    @click="openAddModal()"
                    class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all shadow-md"
                >
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Add Configuration
                </button>
            </div>
        </div>
    </div>

    <!-- Active Config Banner -->
    <div x-show="activeConfig" class="bg-gradient-to-r from-green-50 to-emerald-50 border-b border-green-200 px-6 py-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-green-500 rounded-full p-2">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <div>
                    <div class="text-sm font-semibold text-green-900">Active Configuration</div>
                    <div class="text-xs text-green-700">This configuration is currently running automated jobs</div>
                </div>
            </div>
            <div class="text-xs text-green-600" x-text="activeConfig ? `Last updated: ${formatDate(activeConfig.updated_at)}` : ''"></div>
        </div>
    </div>

    <!-- Stats Bar -->
    <div class="bg-white border-b border-gray-200 px-6 py-3">
        <div class="grid grid-cols-5 gap-4">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-xs text-gray-600 font-medium uppercase tracking-wide">Total Configs</div>
                        <div class="text-2xl font-bold text-[#0F3981] mt-1" x-text="configs.length"></div>
                    </div>
                    <svg class="w-8 h-8 text-[#0F3981] opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                </div>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-xs text-gray-600 font-medium uppercase tracking-wide">Active</div>
                        <div class="text-2xl font-bold text-[#0F3981] mt-1" x-text="configs.filter(c => c.is_active).length"></div>
                    </div>
                    <svg class="w-8 h-8 text-[#0F3981] opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-xs text-gray-600 font-medium uppercase tracking-wide">Search Queries</div>
                        <div class="text-2xl font-bold text-[#0F3981] mt-1" x-text="activeConfig ? (activeConfig.search_queries || []).length : 0"></div>
                    </div>
                    <svg class="w-8 h-8 text-[#0F3981] opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-xs text-gray-600 font-medium uppercase tracking-wide">Countries</div>
                        <div class="text-2xl font-bold text-[#0F3981] mt-1" x-text="activeConfig ? (activeConfig.search_countries || []).length : 0"></div>
                    </div>
                    <svg class="w-8 h-8 text-[#0F3981] opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-xs text-gray-600 font-medium uppercase tracking-wide">Modules</div>
                        <div class="text-2xl font-bold text-[#0F3981] mt-1" x-text="activeConfig ? (activeConfig.enabled_modules || []).length : 0"></div>
                    </div>
                    <svg class="w-8 h-8 text-[#0F3981] opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Configurations List -->
    <div class="flex-1 overflow-auto custom-scrollbar p-6">
        <div class="space-y-4">
            <template x-for="config in configs" :key="config.updated_at || JSON.stringify(config)">
                <div
                    :class="config.is_active ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-white'"
                    class="border-2 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow"
                >
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div x-show="config.is_active" class="bg-green-500 text-white px-3 py-1 rounded-full text-xs font-bold">
                                ACTIVE
                            </div>
                            <div x-show="!config.is_active" class="bg-gray-400 text-white px-3 py-1 rounded-full text-xs font-bold">
                                INACTIVE
                            </div>
                            <div x-show="isConfigLocked(config)" class="bg-yellow-500 text-white px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                                ðŸ”’ LOCKED
                                <span x-text="`(${getLockedMinutesRemaining(config)} min)`"></span>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900">Configuration</h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <button
                                @click.prevent="isConfigLocked(config) ? alert(`ðŸ”’ This configuration is locked for ${getLockedMinutesRemaining(config)} more minutes to ensure buffer time for active scraping jobs.`) : openEditModal(config)"
                                type="button"
                                :class="isConfigLocked(config) ? 'text-gray-400 cursor-not-allowed' : 'text-blue-600 hover:bg-blue-50'"
                                class="px-3 py-1.5 text-sm rounded-lg transition-colors"
                            >
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                                <span x-show="isConfigLocked(config)">ðŸ”’</span> Edit
                            </button>
                            <button
                                x-show="!config.is_active"
                                @click="activateConfig(config)"
                                class="px-3 py-1.5 text-sm text-green-600 hover:bg-green-50 rounded-lg transition-colors"
                            >
                                Activate
                            </button>
                            <button
                                x-show="config.is_active"
                                @click="deactivateConfig(config)"
                                class="px-3 py-1.5 text-sm text-orange-600 hover:bg-orange-50 rounded-lg transition-colors"
                            >
                                Deactivate
                            </button>
                            <button
                                @click="deleteConfig(config)"
                                class="px-3 py-1.5 text-sm text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                            >
                                Delete
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <!-- Left Column -->
                        <div class="space-y-4">
                            <!-- Search Queries -->
                            <div>
                                <div class="text-sm font-medium text-gray-700 mb-2">Search Queries</div>
                                <div class="flex flex-wrap gap-1">
                                    <template x-for="query in (config.search_queries || [])" :key="query">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800" x-text="query"></span>
                                    </template>
                                    <span x-show="!(config.search_queries || []).length" class="text-sm text-gray-400">None</span>
                                </div>
                            </div>

                            <!-- Countries -->
                            <div>
                                <div class="text-sm font-medium text-gray-700 mb-2">Search Countries</div>
                                <div class="flex flex-wrap gap-1">
                                    <template x-for="country in (config.search_countries || [])" :key="country">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800" x-text="country"></span>
                                    </template>
                                    <span x-show="!(config.search_countries || []).length" class="text-sm text-gray-400">None</span>
                                </div>
                            </div>

                            <!-- Modules -->
                            <div>
                                <div class="text-sm font-medium text-gray-700 mb-2">Enabled Modules</div>
                                <div class="flex flex-wrap gap-1">
                                    <template x-for="module in (config.enabled_modules || [])" :key="module">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800" x-text="module"></span>
                                    </template>
                                    <span x-show="!(config.enabled_modules || []).length" class="text-sm text-gray-400">None</span>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="space-y-4">
                            <!-- Settings -->
                            <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Daily Max per Module:</span>
                                    <span class="font-medium text-gray-900" x-text="config.daily_max_per_module"></span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Exhaustive Max per Module:</span>
                                    <span class="font-medium text-gray-900" x-text="config.exhaustive_max_per_module"></span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">BigQuery Enabled:</span>
                                    <span :class="config.enable_bigquery ? 'text-green-600' : 'text-red-600'" class="font-medium" x-text="config.enable_bigquery ? 'Yes' : 'No'"></span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Filtering Enabled:</span>
                                    <span :class="config.enable_filtering ? 'text-green-600' : 'text-red-600'" class="font-medium" x-text="config.enable_filtering ? 'Yes' : 'No'"></span>
                                </div>
                            </div>

                            <!-- Notes -->
                            <div x-show="config.notes">
                                <div class="text-sm font-medium text-gray-700 mb-2">Notes</div>
                                <div class="text-sm text-gray-600 bg-yellow-50 border border-yellow-200 rounded p-3" x-text="config.notes"></div>
                            </div>

                            <!-- Metadata -->
                            <div class="text-xs text-gray-500 space-y-1">
                                <div>Updated: <span x-text="formatDate(config.updated_at)"></span></div>
                                <div x-show="config.updated_by">By: <span x-text="config.updated_by"></span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Loading State -->
        <div x-show="loading" class="flex items-center justify-center h-64">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>

        <!-- Empty State -->
        <div x-show="!loading && configs.length === 0" class="text-center py-12">
            <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No configurations</h3>
            <p class="mt-1 text-sm text-gray-500">Get started by creating a new configuration</p>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div
        x-cloak
        x-show="showModal"
        class="fixed inset-0 z-50 flex items-center justify-center p-4"
        style="background-color: rgba(0, 0, 0, 0.5);"
        @click.self="closeModal()"
    >
        <div
            class="bg-white rounded-lg shadow-xl w-full overflow-y-auto"
            style="max-width: 56rem; max-height: 90vh;"
        >
        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-4 rounded-t-lg flex items-center justify-between">
            <h3 class="text-lg font-bold" x-text="editMode ? 'Edit Configuration' : 'Add New Configuration'"></h3>
            <button @click="closeModal()" class="text-white hover:text-gray-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="p-6 space-y-6">
            <div class="grid grid-cols-2 gap-6">
                <!-- Left Column -->
                <div class="space-y-4">
                    <!-- Search Queries -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Search Queries (comma-separated)</label>
                        <textarea
                            x-model="formData.search_queries_text"
                            placeholder="bigquery, looker, gcp, data engineer"
                            rows="3"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        ></textarea>
                    </div>

                    <!-- Search Countries -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Search Countries (comma-separated)</label>
                        <textarea
                            x-model="formData.search_countries_text"
                            placeholder="Belgium, Netherlands, Luxembourg"
                            rows="2"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        ></textarea>
                    </div>

                    <!-- Enabled Modules -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Enabled Modules (comma-separated)</label>
                        <textarea
                            x-model="formData.enabled_modules_text"
                            placeholder="adzuna, indeed, linkedin"
                            rows="2"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        ></textarea>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-4">
                    <!-- Daily Max -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Daily Max per Module</label>
                        <input
                            type="number"
                            x-model.number="formData.daily_max_per_module"
                            min="0"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>

                    <!-- Exhaustive Max -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Exhaustive Max per Module</label>
                        <input
                            type="number"
                            x-model.number="formData.exhaustive_max_per_module"
                            min="0"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>

                    <!-- Checkboxes -->
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input
                                type="checkbox"
                                x-model="formData.enable_bigquery"
                                class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                            />
                            <span class="ml-2 text-sm text-gray-700">Enable BigQuery</span>
                        </label>
                        <label class="flex items-center">
                            <input
                                type="checkbox"
                                x-model="formData.enable_filtering"
                                class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                            />
                            <span class="ml-2 text-sm text-gray-700">Enable Filtering</span>
                        </label>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                        <textarea
                            x-model="formData.notes"
                            placeholder="Optional configuration notes..."
                            rows="3"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        ></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="bg-gray-50 px-6 py-4 rounded-b-lg flex items-center justify-end gap-3">
            <button
                @click="closeModal()"
                class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
            >
                Cancel
            </button>
            <button
                @click="saveConfig()"
                :disabled="saving"
                class="px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all disabled:opacity-50"
            >
                <span x-show="!saving" x-text="editMode ? 'Update Configuration' : 'Add Configuration'"></span>
                <span x-show="saving">Saving...</span>
            </button>
        </div>
    </div>
</div>

<script>
function configurationData() {
    return {
        configs: [],
        activeConfig: null,
        loading: true,
        showModal: false,
        editMode: false,
        saving: false,
        formData: {
            updated_at: null,
            search_queries_text: '',
            search_countries_text: '',
            enabled_modules_text: '',
            daily_max_per_module: 100,
            exhaustive_max_per_module: 500,
            enable_bigquery: true,
            enable_filtering: true,
            notes: '',
            is_active: false
        },

        init() {
            this.loadConfigurations();
        },

        isConfigLocked(config) {
            if (!config || !config.updated_at) return false;
            
            try {
                const lastUpdated = new Date(config.updated_at.replace(' UTC', ''));
                const now = new Date();
                const minutesPassed = (now - lastUpdated) / 1000 / 60;
                return minutesPassed < 90;
            } catch (e) {
                return false;
            }
        },

        getLockedMinutesRemaining(config) {
            if (!config || !config.updated_at) return 0;
            
            try {
                const lastUpdated = new Date(config.updated_at.replace(' UTC', ''));
                const now = new Date();
                const minutesPassed = (now - lastUpdated) / 1000 / 60;
                return Math.max(0, Math.ceil(90 - minutesPassed));
            } catch (e) {
                return 0;
            }
        },

        async loadConfigurations() {
            try {
                this.loading = true;
                const response = await fetch('/dashboard/configuration/list/');
                const data = await response.json();

                if (data.success) {
                    this.configs = data.configs || [];
                    this.activeConfig = this.configs.find(c => c.is_active) || null;
                } else {
                    console.error('Failed to load configs:', data.error);
                    alert('Error loading configurations: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to load configurations:', error);
                alert('Failed to connect to server: ' + error.message);
            } finally {
                this.loading = false;
            }
        },

        openAddModal() {
            this.editMode = false;
            this.formData = {
                updated_at: null,
                search_queries_text: '',
                search_countries_text: '',
                enabled_modules_text: '',
                daily_max_per_module: 100,
                exhaustive_max_per_module: 500,
                enable_bigquery: true,
                enable_filtering: true,
                notes: '',
                is_active: false
            };
            this.showModal = true;
        },

        openEditModal(config) {
            this.editMode = true;
            
            const queries = (config.search_queries || []).join(', ');
            const countries = (config.search_countries || []).join(', ');
            const modules = (config.enabled_modules || []).join(', ');
            
            this.formData = {
                updated_at: config.updated_at || null,
                search_queries_text: queries,
                search_countries_text: countries,
                enabled_modules_text: modules,
                daily_max_per_module: config.daily_max_per_module,
                exhaustive_max_per_module: config.exhaustive_max_per_module,
                enable_bigquery: config.enable_bigquery,
                enable_filtering: config.enable_filtering,
                notes: config.notes || '',
                is_active: config.is_active
            };
            this.showModal = true;
        },        closeModal() {
            this.showModal = false;
            this.editMode = false;
        },

        async saveConfig() {
            try {
                this.saving = true;
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

                const payload = {
                    search_queries: this.formData.search_queries_text.split(',').map(s => s.trim()).filter(s => s),
                    search_countries: this.formData.search_countries_text.split(',').map(s => s.trim()).filter(s => s),
                    enabled_modules: this.formData.enabled_modules_text.split(',').map(s => s.trim()).filter(s => s),
                    daily_max_per_module: this.formData.daily_max_per_module,
                    exhaustive_max_per_module: this.formData.exhaustive_max_per_module,
                    enable_bigquery: this.formData.enable_bigquery,
                    enable_filtering: this.formData.enable_filtering,
                    notes: this.formData.notes,
                    is_active: this.formData.is_active
                };

                if (this.editMode && this.formData.updated_at) {
                    payload.updated_at = this.formData.updated_at;
                }

                const response = await fetch('/dashboard/configuration/save/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                if (data.success) {
                    this.closeModal();
                    this.loadConfigurations();
                } else {
                    // Check if configuration is locked
                    if (data.locked && data.minutes_remaining) {
                        alert(`ðŸ”’ Configuration Locked\n\nThis configuration was last updated at ${data.last_updated}.\n\nChanges cannot be made for ${data.minutes_remaining} more minutes to ensure buffer time for active scraping jobs.\n\nPlease try again later.`);
                    } else {
                        alert('Error: ' + data.error);
                    }
                }
            } catch (error) {
                console.error('Failed to save configuration:', error);
                alert('Failed to save configuration');
            } finally {
                this.saving = false;
            }
        },

        async activateConfig(config) {
            if (!(config && config.updated_at)) {
                alert('Unable to activate: missing configuration timestamp.');
                return;
            }

            if (!confirm('Activate this configuration? This will deactivate the current active configuration.')) {
                return;
            }

            try {
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                
                const response = await fetch('/dashboard/configuration/activate/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ config: config })
                });

                const data = await response.json();
                
                if (data.success) {
                    this.loadConfigurations();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Failed to activate configuration:', error);
            }
        },

        async deactivateConfig(config) {
            if (!(config && config.updated_at)) {
                alert('Unable to deactivate: missing configuration timestamp.');
                return;
            }

            if (!confirm('Deactivate this configuration? Automated jobs will stop running.')) {
                return;
            }

            try {
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                
                const response = await fetch('/dashboard/configuration/deactivate/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ config: config })
                });

                const data = await response.json();
                
                if (data.success) {
                    this.loadConfigurations();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Failed to deactivate configuration:', error);
            }
        },

        async deleteConfig(config) {
            if (!(config && config.updated_at)) {
                alert('Unable to delete: missing configuration timestamp.');
                return;
            }

            if (!confirm('Delete this configuration? This action cannot be undone.')) {
                return;
            }

            try {
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                
                const response = await fetch('/dashboard/configuration/delete/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ config: config })
                });

                const data = await response.json();
                
                if (data.success) {
                    this.loadConfigurations();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Failed to delete configuration:', error);
            }
        },

        formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        },
        
        isConfigLocked(config) {
            if (!config || !config.updated_at) return false;
            
            try {
                const updatedAt = new Date(config.updated_at.replace(' UTC', ''));
                const now = new Date();
                const minutesPassed = (now - updatedAt) / (1000 * 60);
                
                return minutesPassed < 90;
            } catch (e) {
                console.error('Error checking lock status:', e);
                return false;
            }
        },
        
        getLockedMinutesRemaining(config) {
            if (!config || !config.updated_at) return 0;
            
            try {
                const updatedAt = new Date(config.updated_at.replace(' UTC', ''));
                const now = new Date();
                const minutesPassed = (now - updatedAt) / (1000 * 60);
                const remaining = Math.max(0, Math.ceil(90 - minutesPassed));
                
                return remaining;
            } catch (e) {
                console.error('Error calculating remaining time:', e);
                return 0;
            }
        }
    };
}
</script>
{% endblock %}
